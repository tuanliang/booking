# e店邦O2O平台

## 一、项目介绍

本文档描述了e店邦O2O平台系统的整体需求，包括功能性需求和非功能性需求等内容。本文档可以作为概要设计的参考资料。

### 1.1、项目背景

为了更好的进行商户门店运营，以及维护新老客户的信息，广州xxx汽车服务公司决定实施汽车门店管理系统。但市面上出售的系统价格昂贵，笨重，所以经过市场调研研究，单独对该公司，做一个轻量级的互联网门店运营系统，主要功能包括商铺维护，服务预约，消费结算，财务审核，客户关系维护，订单发货，物流跟踪，客户评价，报表分析等功能。

### 1.2、项目结构

e店邦O2O平台项目根据实际需要将项目拆分成2部分：前端官网(frontend)， 后端管理平台(car_o2o)。

#### 1.2.1、前端官网(拓展)

核心模块：官网数据展示，养修服务预约，续保服务登记，购车相关的金融服务等

#### 1.2.2、后端管理平台

核心模块：系统管理模块， 系统监控， **养修预约， 套餐审核，报表管理，流程管理，**个人中心等。

#### 1.2.3、项目演示

通过阅读项目文档，启动演示项目开观察项目要做哪些功能，了解整体要做的需求

文档地址：https://www.kdocs.cn/l/cn6kn89b9MdF

启动演示项目操作步骤：

- 创建数据库 carO2O,把准备好的 sql文件导入进去
- 修改 application-druid的连接信息
- 进入到前端项目执行 npm install -> npm run dev

## 二、项目重构

### 2.1、为什么要进行重构

首先，重构是时刻保证代码质量的一个极其有效的手段，不至于让代码腐化到无可救药的地步。项目在演进，代码不停地在堆砌。如果没有人为代码的质量负责任，代码总是会往越来越混乱的方向演进。当混乱到一定程度之后，量变引起质变，项目的维护成本已经高过重新开发一套新代码的成本，想要再去重构，已经没有人能做到了。

>  问：我们现在做一个新的项目什么要重构？重构谁？
>
> 答：我们要基于 RuoYi 进行 2 次开发，现在 RuoYi 已经提供了一份基础代码了， 但是他的很多规范都是 RuoYi 的规范，比如包的命名，配置信息等

重构的过程要改动之前的一些代码或者配置，所以报错是非常常见的。

### 2.2、手动重构

操作步骤

1、修改项目名字把 ruoyi 修改成 wolfcode 

![image-20221120113529017](images/image-20221120113529017.png)

2、修改模块名称把 ruoyi 修改成 wolfcode

![image-20221120113529017](images/image-20221120113529017.png)

3、修改父项目的 pom 文件，把坐标改成 wolfcode 开头

![image-20221120113637732](images/image-20221120113637732.png)

把下面的版本也要进行修改，当然可以直接统一替换

![image-20221120113717862](images/image-20221120113717862.png)

模块名称修改

![image-20221120113748684](images/image-20221120113748684.png)

4、 找到每一个模块的 pom 文件，修改 parent 标签和模块名字

![image-20221120113907205](images/image-20221120113907205.png)

把下面的依赖坐标进行修改

![image-20221120113939319](images/image-20221120113939319.png)

其他模块都是重复操作，就不进行截图了。

5 、修改包的命名，改成 cn.wolfcode

![image-20221120114044762](images/image-20221120114044762.png)

6、 修改完以后会发现很多地方的 import 都会报错，我们进行统一全局替换 ctrl+shift+R , 把 com.ruoyi 修改成 cn.wolfcode 

![image-20221120114204773](images/image-20221120114204773.png)

7、 把启动类修改成 WolfCodeApplication

8、修改 banner，把准备好的 banner.txt文件替换之前的

9 、启动以后发现验证码加载不出来，控制器报错需要修改CaptchaConfig中getKaptchaBeanMath方法属性

```java
 // 验证码文本生成器
 properties.setProperty(KAPTCHA_TEXTPRODUCER_IMPL, "cn.wolfcode.framework.config.KaptchaTextCreator");
```

10、全局替换把若依管理系统修改成e店邦管理系统

11、替换前端的 logo.png、favicon.ico

12、把前段的 index.vue界面template内容删掉，换成欢迎来到e 店邦平台

### 2.3、使用 RuoYi 改造期进行重构

操作步骤：

1、安装 RuoYi 改造器，这个无脑下一步进行安装就可以了

2、按照下图进行配置，然后点击执行

![image-20221120153153265](images/image-20221120153153265.png)

3、其他操作步骤一样

> 注：RuoYi 的改造器盖起来虽然简单， 但是大家要记住并不是所有的项目都有代码改造期的，有一些项目重构是需要我们自己手动去进行修改。

## 三、后端功能需求

### 3.1：养修预约

#### 3.1.1：功能描述

当客户爱车需要保养或者维修时，客户可以选择自己就近的门店进行养修服务消费，这个我们称之为线下消费，如果用户从官网填单或者电话通知的方法约定某个时间到店消费，这行为称之为预约。当前需求是针对预约行为。

<span style="font-size:18px">预约方式</span>

****

1>电话咨询预约，店铺客服自行录入数据进入系统。【电话预约】

2>客户打开门户官网进行预约提交，则自动添加进入系统  。【官网填单预约】【拓展】

注意：本需求重点讲解【电话预约】方式

#### 3.1.2、具体需求

观察原型发现项目中需要实现的功能，也可以通过演示项目观察需求，但是大家要知道以后进入到公司中是没有演示项目的只有原型甚至原型都没有，只是口头告诉你做什么，这个时候一定要问清楚要做什么。

原型：

![image-20221120172931013](images/image-20221120172931013.png)

通过原型大体看到功能如下：

- 1、养修预约记录列表查询

- 2、养修预约记录添加

- 3、养修预约记录编辑

- 4、养修预约取消

- 5、养修预约记录删除

- 6、到店消费，客户按照约定的时间到店消费后，实现消费

- 7、消费完成后，对客户消费服务项目进行结算

#### 3.1.3、表设计

思考：养修服务预约表应该怎么设计？

考虑因素：

- 1、所见即所得 
- 2、表中的数据是否有字段是固定的来源于数据字典 
- 3、列表展示数据是否要连表 
- 4、是否有隐藏字段

表：bus_appointment

![image-20211008125920528](images/image-20211008125920528.png)

表中重点需要考虑的两个字段**服务类型**和**状态**：

**服务类型**： 这里系统中只有两个类型维修和保养，数据来源于数据字典
status：预约中，已到店，取消，结算单生成，已支付，超时取消

<span style="color:red">状态分析：</span>

<hr>

预约中：        当用于打电话预约或者是在官网中进行预约处于预约中状态
已到店：        当用户预约了并且实际到店了处于到店状态
取     消：       当用户预约了但是有事临时来不了取消了处于此状态
结算单生成：当用户到店消费了要生成结算单处于这个状态
已支付 ：       当用户消费完并且按照结算单支付了处于此状态
超时取消：    当用户预约了但是长时间没来，打电话也沟通不上系统可以自动取消

<hr>

#### 3.1.4 、添加菜单按钮

目前整个 RuoYi 中提供的菜单中是没有养修预约的目录和按钮的，所以我们需要利用RuoYi 提供的菜单功能添加按钮

操作步骤：

1 、找到菜单管理-》新增

![image-20221120171952128](images/image-20221120171952128.png)

2、新增一个养修预约的目录

![image-20221120172033444](images/image-20221120172033444.png)

3、点击养修预约数据的新增

![image-20221120172105795](images/image-20221120172105795.png)

4、添加菜单

![image-20221120172131456](images/image-20221120172131456.png)

5、在前段项目中的 views 中添加 business 目录，然后在 business 目录中创建 appointmnet 目录，在拷贝一个 index.vue的文件

![image-20221120172253441](images/image-20221120172253441.png)

#### 3.1.5、创建模块 wolfcode-business

这个模块是一个独立模块，主要就是放我们项目中的业务功能

`<img src="/Users/fanjialong/Documents/%E5%A4%87%E8%AF%BE%E8%A7%86%E9%A2%91/%E6%9C%80%E6%96%B0%E9%A1%B9%E7%9B%AE%E8%AF%BE%E4%BB%B6%E6%95%B4%E7%90%86/11-carO2O/%E8%AE%B2%E4%B9%89/images/image-20221121145224739.png" width="400px" height="400px"/>

把 wolfcode-business加入到 wolfcode-admin中，因为我们程序的入口是 wolfcode-admin

```xml
<dependency>
    <groupId>cn.wolfcode</groupId>
    <artifactId>wolfcode-appointment</artifactId>
</dependency>
```

在父项目中dependencyManagement加入，这样在子项目中就不需要写版本了

```xml
<dependency>
    <groupId>cn.wolfcode</groupId>
    <artifactId>wolfcode-appointment</artifactId>
    <version>3.8.3</version>
</dependency>
```

把生成的代码拷贝到包中重新启动项目。



#### 3.1.6、养修预约列表

##### 3.1.6.1、页面效果

![image-20221120172931013](images/image-20221120172931013.png)

<span style="font-size: 20px">操作按钮:</span>

**按钮显示要求：**

当记录状态是预约中， 编辑，到店，取消，删除可用，结算单不可用

当记录状态是已到店， 编辑，到店，取消，删除不可用, 结算单可用，

当记录状态是用户取消，编辑，到店，取消, 结算单不可用，删除可用

当记录状态是结算单生成，编辑，到店，取消，删除不可用, 结算单可用

当记录状态是已支付，编辑，到店，取消，删除不可用, 结算单可用



##### 3.1.6.2、生成代码

实现步骤 1：通过代码生成工具生成 domain、mapper、service、impl、controller、vue 界面文件

代码生成信息：

![image-20221121144906120](images/image-20221121144906120.png)

实体类用我们自己的，多了一些状态属性。

```java
@Getter
@Setter
public class BusAppointment extends BaseEntity
{

    public static final Integer STATUS_APPOINTMENT = 0;//预约中
    public static final Integer STATUS_ARRIVAL = 1;//已到店
    public static final Integer STATUS_CANCEL = 2;//用户取消
    public static final Integer STATUS_OVERTIME = 3;//超时取消
    public static final Integer STATUS_SETTLE  = 4;//结算单生成
    public static final Integer STATUS_PAYED  = 5;//已支付

    private static final long serialVersionUID = 1L;

    /** $column.columnComment */
    private Long id;

    /** 客户姓名 */
    @Excel(name = "客户姓名")
    private String customerName;

    /** 客户联系方式 */
    @Excel(name = "客户联系方式")
    private String customerPhone;

    /** 预约时间 */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @Excel(name = "预约时间", width = 30, dateFormat = "yyyy-MM-dd HH:mm:ss")
    private Date appointmentTime;

    /** 实际到店时间 */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @Excel(name = "实际到店时间", width = 30, dateFormat = "yyyy-MM-dd  HH:mm:ss")
    private Date actualArrivalTime;

    /** 车牌号码 */
    @Excel(name = "车牌号码")
    private String licensePlate;

    /** 汽车类型 */
    @Excel(name = "汽车类型")
    private String carSeries;

    /** 服务类型【维修0/保养1】 */
    @Excel(name = "服务类型【维修0/保养1】")
    private Integer serviceType;

    /** 备注信息 */
    @Excel(name = "备注信息")
    private String info;

    /** 状态【预约中0/已到店1/用户取消2/超时取消3】 */
    @Excel(name = "状态【预约中0/已到店1/用户取消2/超时取消3】")
    private Integer status;

    
}

```

##### 3.1.6.4、处理界面

当我们访问到界面发现有几个问题:

- 高级查询部分
- 按钮部分
- 表格列显示部分

**1、高级查询**： 这部分的内容我们直接删除就可以了即可
**2、按钮**：   这部分的内容也是把多余的内容给删除掉即可

**3、表格**：   
  3.1、表格id，多余字段需要删除  
  3.2、服务类型和状态应该是来源于数据字典

找到字典管理添加类型

![image-20221121150531104](images/image-20221121150531104.png)

添加字典明细

![image-20221121150605368](images/image-20221121150605368.png)

4、添加完类型可以处理数据字典内容的回显，可以参考岗位界面

```html

<el-table-column label="状态" align="center" prop="status" >
        <template slot-scope="scope">
          <dict-tag :options="dict.type.bus_appointment_status" :value="scope.row.status"/>
        </template>
</el-table-column>


dicts: ["bus_service_type","bus_appointment_status"]
```

5、处理按钮：

```html
<el-table-column label="操作" align="center" class-name="small-padding fixed-width">
  <template slot-scope="scope">
    <el-button
      size="mini"
      type="text"
      icon="el-icon-edit"
      @click="handleUpdate(scope.row)"
      v-hasPermi="['business:appointment:edit']"
      v-if="scope.row.status == 0"
    >修改</el-button>
    <el-button
      size="mini"
      type="text"
      icon="el-icon-delete"
      v-if="scope.row.status == 0"
      @click="arralShop(scope.row)"
    >到店</el-button>
    <el-button
      size="mini"
      type="text"
      icon="el-icon-delete"
      v-if="scope.row.status == 1 || scope.row.status == 3 || scope.row.status == 5"
      @click="handlerDetail(scope.row)"
    >结算单</el-button>
    <el-dropdown size="mini" @command="(command) => handleCommand(command, scope.row)">
          <span class="el-dropdown-link">
            <i class="el-icon-d-arrow-right el-icon--right"></i>更多
          </span>
    <el-dropdown-menu slot="dropdown">
      <el-dropdown-item command="handleCancel" v-if="scope.row.status==0" icon="el-icon-key"
      >取消</el-dropdown-item>
      <el-dropdown-item command="handlerDelete" v-if="scope.row.status==0 || scope.row.status==2" icon="el-icon-circle-check"
      >删除</el-dropdown-item>
    </el-dropdown-menu>
  </el-dropdown>

  </template>
</el-table-column>
```

#### 3.1.7、养修预约新增

##### 3.1.7.1、界面效果

![image-20221121151045642](images/image-20221121151045642.png)

##### 3.1.7.2、处理前端

需要添加一个服务类型加拉框，也可以参考岗位操作

```html
<el-form-item label="服务类型" prop="serviceType">
  <el-select v-model="form.serviceType" placeholder="服务类型" clearable>
    <el-option
      v-for="dict in dict.type.bus_service_type"
      :key="dict.value"
      :label="dict.label"
      :value="dict.value"
    />
  </el-select>
</el-form-item>
```

##### 3.1.7.3、处理后端逻辑

实现思路：

- 参数校验
- 手机号码格式校验
- 车牌号码格式校验
- 判断日期是否合理
- 新增

代码:

```java
@Override
public int insertBusAppointment(BusAppointmentVO busAppointment) {
    //做非空判断
    Assert.notNull(busAppointment, "参数不能为 null");
  
        boolean phoneLegal = RegexUtils.isPhoneLegal(busAppointment.getCustomerPhone());
        if(!phoneLegal){
            throw new RuntimeException("手机号码不正确");
        }
        //车牌号码校验
        VehiclePlateNoUtil.VehiclePlateNoEnum vehiclePlateNo = VehiclePlateNoUtil.getVehiclePlateNo(busAppointment.getLicensePlate());
        if(vehiclePlateNo == null){
            throw new RuntimeException("车牌号不正确");
        }
    //做合理化校验,日期校验
    Date appointmentTime = busAppointment.getAppointmentTime();
    Date nowDate = DateUtils.getNowDate();
    boolean flag = appointmentTime.before(nowDate);
    Assert.state(flag, "预约时间不合理");

    //进行赋值操作
    BusAppointment busAppointment1 = new BusAppointment();
    BeanUtils.copyProperties(busAppointment, busAppointment1);

    busAppointment.setCreateTime(DateUtils.getNowDate());
    return busAppointmentMapper.insertBusAppointment(busAppointment1);
}
```

手机号码工具类

```java
public class RegexUtils {
    /**
     * 大陆号码或香港号码均可
     */
    public static boolean isPhoneLegal(String str)throws PatternSyntaxException {
        return isChinaPhoneLegal(str) || isHKPhoneLegal(str);
    }
 
    /**
     * 大陆手机号码11位数，匹配格式：前三位固定格式+后8位任意数
     * 此方法中前三位格式有：
     * 13+任意数
     * 15+除4的任意数
     * 18+任意数
     * 17+除9的任意数
     * 147
     */
    public static boolean isChinaPhoneLegal(String str) throws PatternSyntaxException {
        String regExp = "^((13[0-9])|(15[^4])|(18[0-9])|(17[0-8])|(147))\\d{8}$";
        Pattern p = Pattern.compile(regExp);
        Matcher m = p.matcher(str);
        return m.matches();
    }
 
    /**
     * 香港手机号码8位数，5|6|8|9开头+7位任意数
     */
    public static boolean isHKPhoneLegal(String str)throws PatternSyntaxException {
        String regExp = "^(5|6|8|9)\\d{7}$";
        Pattern p = Pattern.compile(regExp);
        Matcher m = p.matcher(str);
        return m.matches();
    }
 
    public static void main(String[] args) {
        boolean phoneLegal = RegexUtils.isPhoneLegal("手机号码");
        System.out.println(phoneLegal);
    }
}
```

车牌号码工具类:

```java
public class VehiclePlateNoUtil {
    /**
     * 获取车牌类型信息
     *
     * @param plateNo
     * @return 返回null，表示车牌不匹配
     */
    public static VehiclePlateNoEnum getVehiclePlateNo(String plateNo) {
        for (VehiclePlateNoEnum vehiclePlateNoEnum : VehiclePlateNoEnum.values()) {
            Matcher matcher = vehiclePlateNoEnum.pattern.matcher(plateNo);
            if (matcher.find()) {
                return vehiclePlateNoEnum;
            }
        }
        return null;
    }


    public enum VehiclePlateNoEnum {
        /**
         * 匹配民用车牌和使馆车牌
         * 1、第一位为汉子省份缩写
         * 2、第二位为大写字母城市编码
         * 3、后面是5位仅含字母和数字的组合
         */
        CIVIL_LICENSE_PLATE_AND_EMBASSY_LICENSE_PLATE(1, "民用车牌和使馆车牌", Pattern.compile("^[京津冀晋蒙辽吉黑沪苏浙皖闽赣鲁豫鄂湘粤桂琼川贵云渝藏陕甘青宁新]{1}[A-Z]{1}[0-9a-zA-Z]{5}$")),
        /**
         * 匹配特种车牌(挂,警,学,领,港,澳)
         */
        SPECIAL_LICENSE_PLATES(2, "特种车牌", Pattern.compile("^[京津冀晋蒙辽吉黑沪苏浙皖闽赣鲁豫鄂湘粤桂琼川贵云渝藏陕甘青宁新]{1}[A-Z]{1}[0-9a-zA-Z]{4}[挂警学领港澳]{1}$")),
        /**
         * 匹配
         */
        ARMED_POLICE_CAR(3, "武警车牌", Pattern.compile("^WJ[京津冀晋蒙辽吉黑沪苏浙皖闽赣鲁豫鄂湘粤桂琼川贵云渝藏陕甘青宁新]?[0-9a-zA-Z]{5}$")),
        /**
         * 匹配军牌
         */
        MILITARY_CAR(4, "军用车牌", Pattern.compile("^[A-Z]{2}[0-9]{5}$")),
        /**
         * 小型新能源车
         * 1、匹配新能源车辆6位车牌
         */
        SMALL_NEW_ENERGY_VEHICLE(5, "小型新能源车牌", Pattern.compile("^[京津冀晋蒙辽吉黑沪苏浙皖闽赣鲁豫鄂湘粤桂琼川贵云渝藏陕甘青宁新]{1}[A-Z]{1}[DF]{1}[0-9a-zA-Z]{5}$")),
        /**
         * 大型新能源车
         */
        LARGE_NEW_ENERGY_VEHICLE(6, "大型新能源车牌", Pattern.compile("^[京津冀晋蒙辽吉黑沪苏浙皖闽赣鲁豫鄂湘粤桂琼川贵云渝藏陕甘青宁新]{1}[A-Z]{1}[0-9a-zA-Z]{5}[DF]{1}$"));
        private int code;

        private String description;

        private Pattern pattern;

        VehiclePlateNoEnum(int code, String description, Pattern pattern) {
            this.code = code;
            this.description = description;
            this.pattern = pattern;
        }

        public int getCode() {
            return code;
        }

        public String getDescription() {
            return description;
        }
    }
}
```

#### 3.1.8、养修预约编辑

##### 3.1.8.1、界面效果

![image-20221121151931724](images/image-20221121151931724.png)

##### 3.1.8.2、处理后端逻辑

**实现思路:**

- 参数合理化校验
- 手机号码校验
- 车牌号码校验
- 日期校验
- 判断是否在预约中否则抛出异常
- 修改数据

**代码：**

```java
  @Override
    public int updateBusAppointment(BusAppointmentVO busAppointment) {
        //做非空判断
//        Assert.notNull(busAppointment,"参数不能为 null");
        if (busAppointment == null) {
            throw new IllegalArgumentException("参数不能为空");
        }
      
        boolean phoneLegal = RegexUtils.isPhoneLegal(busAppointment.getCustomerPhone());
        if(!phoneLegal){
            throw new RuntimeException("手机号码不正确");
        }
        //车牌号码校验
        VehiclePlateNoUtil.VehiclePlateNoEnum vehiclePlateNo = VehiclePlateNoUtil.getVehiclePlateNo(busAppointment.getLicensePlate());
        if(vehiclePlateNo == null){
            throw new RuntimeException("车牌号不正确");
        }

        //做合理化校验,日期校验
        Date appointmentTime = busAppointment.getAppointmentTime();
        Date nowDate = DateUtils.getNowDate();
        boolean flag = appointmentTime.before(nowDate);
//        Assert.state(flag,"预约时间不合理");
        if(flag){
            throw new IllegalArgumentException("预约时间不合理");
        }
        //判断状态是否在预约中
        BusAppointment appointment = selectBusAppointmentById(busAppointment.getId());
        if (!BusAppointment.STATUS_APPOINTMENT.equals(appointment.getStatus())) {
            throw new IllegalArgumentException("非法操作");
        }
        BusAppointment bus = new BusAppointment();
        BeanUtils.copyProperties(busAppointment,bus);
        return busAppointmentMapper.updateBusAppointment(bus);
    }
```

#### 3.1.9、养修预约到店

需求：用户预约完以后实际到店消费，把用户状态由预约中修改为到店状态

##### 3.1.9.1、界面效果

![image-20221123143428169](images/image-20221123143428169.png)

##### 3.1.9.1、处理前端

1、前端添加按钮

```html
<el-button
  size="mini"
  type="text"
  icon="el-icon-delete"
  @click="arralShop(scope.row)"
>到店</el-button>
```

2、在 appointment.js中添加请求信息

```js
// 到店
export function arral(id) {
  return request({
    url: '/business/appointment/arral/' + id,
    method: 'put'
  })
}
```

3、在 index.vue导入

```js
import { listAppointment,getAppointment ,handlerCancel, delAppointment,arral, addAppointment, updateAppointment } from "@/api/business/appointment";
```

4、发送请求代码

```js
arralShop(row) {
  const ids = row.id || this.ids;
  this.$modal.confirm('确定到店吗').then(function() {
    return arral(ids);
  }).then(() => {
    this.getList();
    this.$modal.msgSuccess("到店成功");
  }).catch(() => {});
},
```

##### 3.1.9.2、处理后端逻辑

**实现：**

- 前端点击到店按钮弹出一个确定框
- 点击确定发送一个 ajax 请求
- 后台接受请求，做参数校验，
- 把状态修改成到店状态同时要修改到店时间

代码：

```java
@Override
public int arralShop(Long id) {

    //参数校验
    if(id == null){
        throw new RuntimeException("非法参数");
    }

    //状态判断
    BusAppointment busAppointment = this.selectBusAppointmentById(id);
    if(!BusAppointment.STATUS_APPOINTMENT.equals(busAppointment.getStatus())){

        throw new RuntimeException("状态必须为预约中");
    }

    return busAppointmentMapper.arralShop(id,BusAppointment.STATUS_ARRIVAL);
}
```

#### 3.1.10、养修预约取消

需求：用户预约完以后有事来不了取消，需要把状态由预约中修改成取消状态

##### 3.1.10.1、处理前端

1、添加按钮

```html
 <el-dropdown size="mini" @command="(command) => handleCommand(command, scope.row)">
        <span class="el-dropdown-link">
          <i class="el-icon-d-arrow-right el-icon--right"></i>更多
        </span>
  <el-dropdown-menu slot="dropdown">
    <el-dropdown-item command="handleCancel" icon="el-icon-key"
    >取消</el-dropdown-item>
    <el-dropdown-item command="handlerDelete" icon="el-icon-circle-check"
    >删除</el-dropdown-item>
  </el-dropdown-menu>
</el-dropdown>
```

2、在 appointment.js中添加请求信息

```js
// 取消
export function handlerCancel(id) {
  return request({
    url: '/business/appointment/cancel/' + id,
    method: 'put'
  })
}
```

3、在 index.js中引入

```js
import { listAppointment,getAppointment ,handlerCancel, delAppointment,arral, addAppointment, updateAppointment } from "@/api/business/appointment";
```

4、发送请求

```js
handleCommand(command, row) {
  switch (command) {
    case "handleCancel":
      this.handleCancel(row);
      break;
    case "handleDelete":
      this.handleDelete(row);
      break;
    default:
      break;
  }
},
 handleCancel(row) {
      const ids = row.id || this.ids;
      this.$modal.confirm('是否取消').then(function() {
        return handlerCancel(ids);
      }).then(() => {
        this.getList();
        this.$modal.msgSuccess("取消成功");
      }).catch(() => {});
    },

```

##### 3.1.10.2、处理后端逻辑

**实现思路：**

- 前端点击取消按钮
- 发送 ajax 请求到后端
- 后端接受请求，做参数校验
- 把状态修改为取消状态

**代码:**

```java
@Override
public int cancel(Long id) {
    //参数校验
    if(id == null){
        throw new RuntimeException("非法参数");
    }

    //状态判断
    BusAppointment busAppointment = this.selectBusAppointmentById(id);
    if(!BusAppointment.STATUS_APPOINTMENT.equals(busAppointment.getStatus())){

        throw new RuntimeException("状态必须为预约中");
    }

    return busAppointmentMapper.cancel(id,BusAppointment.STATUS_CANCEL);
}
```

## 3.2、服务单项

### 3.2.1、功能描述

当前线下门店(4s店)能为客户爱车提供哪些服务。一般服务分2大类，一类是单项服务，一个是套餐服务(捆绑多个单项服务)。业务要求如果是套餐服务需要店长、财务审批之后才可以上架销售。

原型：

![image-20221123144945040](images/image-20221123144945040.png)

### 3.2.2、具体需求

1、养修服务单项查询列表

2、养修服务单项添加

3、养修服务单项编辑

4、养修服务单项上架/下架

5、养修服务套餐审核

###  3.2.3、表设计

思考：养修服务单项表如何设计？

![image-20211008172235298](images/image-20211008172235298.png)

需要注意字段：是否套餐、服务分类、审核状态、上架状态

是否套餐：只有是和否来源于数据字典
服务分类：只有维修和保养来源于数据字典
上架状态：只有上架和下架来源于数据字典
审批状态：初始化、审批中、审核通过、重新调整、无序审核状态

### 3.2.4：养修服务单项列表

#### 3.2.4.1、界面效果

![image-20221123150147821](images/image-20221123150147821.png)

<span style="font-size: 20px">操作按钮:</span>

界面按钮**：新增、编辑、上架、下架、发起审核

**新增按钮**：没什么限制

**编辑按钮**：
      1、处于上架状态和审核中状态不能编
      2、如果是套餐并且是审批通过状态， 修改完以后要把状态修改成初始化

**上架按钮**：
      1、只有处于下架状态才可以上架
      2、看是否是套餐，如果是非套餐可以直接上架，如果是套餐需要是审核通过才可以上架

**下架按钮：**
      1、处于上架状态就可以上架

**发起审核**：占时不考虑等做完流程定义相关在做考虑

#### 3.2.4.2、生成代码

通过代码生成器生成 domain、mapper、xml、service、impl、vue

养修服务单项状态

```java
@Getter
@Setter
@ToString
public class BusServiceItem extends BaseEntity
{

    private static final long serialVersionUID = 1L;
    public static final String CARPACKAGE_NO = "0";//不是套餐
    public static final String CARPACKAGE_YES = "1";//是套餐

    public static final String AUDITSTATUS_INIT = "0";//初始化
    public static final String AUDITSTATUS_AUDITING = "1";//审核中
    public static final String AUDITSTATUS_APPROVED = "2";//审核通过
    public static final String AUDITSTATUS_REPLY = "3";//重新调整
    public static final String AUDITSTATUS_NO_REQUIRED = "4";//无需审核

    public static final String SALESTATUS_OFF = "0";//下架
    public static final String SALESTATUS_ON = "1";//上架



    /** $column.columnComment */
    private Long id;

    /** 服务项名称 */
    @Excel(name = "服务项名称")
    private String name;

    /** 服务项原价 */
    @Excel(name = "服务项原价")
    private BigDecimal originalPrice;

    /** 服务项折扣价 */
    @Excel(name = "服务项折扣价")
    private BigDecimal discountPrice;

    /** 是否套餐【是/否】 */
    @Excel(name = "是否套餐【是/否】")
    private String carPackage;

    /** 备注信息 */
    @Excel(name = "备注信息")
    private String info;

    /** 服务分类【维修/保养/其他】 */
    @Excel(name = "服务分类【维修/保养/其他】")
    private String serviceCatalog;

    /** 审核状态【初始化/审核中/审核通过/审核拒绝/无需审核】 */
    @Excel(name = "审核状态【初始化/审核中/审核通过/审核拒绝/无需审核】")
    private String auditStatus;

    /** 上架状态【已上架/未上架】 */
    @Excel(name = "上架状态【已上架/未上架】")
    private String saleStatus;

}
```

#### 3.2.4.3、处理界面

**高级查询部分**

先把多余的给删除掉，界面中有 4 个下拉框高级查询，都是来源于数据字典

```html
  <el-form :model="queryParams" ref="queryForm" size="small" :inline="true" v-show="showSearch" label-width="68px">
      <el-form-item label="服务项名称" prop="name">
        <el-input
          v-model="queryParams.name"
          placeholder="请输入服务项名称"
          clearable
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>

      <el-form-item label="是否套餐" prop="carPackage">
        <el-select v-model="queryParams.carPackage" placeholder="是否套餐" clearable>
          <el-option
            v-for="dict in dict.type.bus_car_package"
            :key="dict.value"
            :label="dict.label"
            :value="dict.value"
          />
        </el-select>
      </el-form-item>

      <el-form-item label="服务分类" prop="serviceCatalog">
        <el-select v-model="queryParams.serviceCatalog" placeholder="服务分类" clearable>
          <el-option
            v-for="dict in dict.type.bus_service_type"
            :key="dict.value"
            :label="dict.label"
            :value="dict.value"
          />
        </el-select>
      </el-form-item>

      <el-form-item label="审批状态" prop="auditStatus">
        <el-select v-model="queryParams.auditStatus" placeholder="审批状态" clearable>
          <el-option
            v-for="dict in dict.type.bus_item_status"
            :key="dict.value"
            :label="dict.label"
            :value="dict.value"
          />
        </el-select>
      </el-form-item>

      <el-form-item label="上架状态" prop="saleStatus">
        <el-select v-model="queryParams.saleStatus" placeholder="上架状态" clearable>
          <el-option
            v-for="dict in dict.type.bus_sale_status"
            :key="dict.value"
            :label="dict.label"
            :value="dict.value"
          />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" icon="el-icon-search" size="mini" @click="handleQuery">搜索</el-button>
        <el-button icon="el-icon-refresh" size="mini" @click="resetQuery">重置</el-button>
      </el-form-item>
    </el-form>

```

js中

```js
dicts: ["bus_service_type","bus_item_status","bus_car_package","bus_sale_status"],
```

**按钮部分：**把多余按钮给删除掉即可

**列表部分：**要处理数据字典回显问题

标签中加入

```html
<template slot-scope="scope">
  <dict-tag :options="dict.type.bus_car_package" :value="scope.row.carPackage"/>
</template>
```

### 3.2.5、养修服务单项新增

#### 3.2.5.1、界面效果

![image-20221124144204696](images/image-20221124144204696.png)

#### 3.2.5.2、处理前端

界面中需要处理的一个是否套餐，还有一个服务分类

是否套餐： 拷贝部门新增界面中内容

```html
<el-radio-group v-model="form.carPackage">
  <el-radio
    v-for="dict in dict.type.bus_car_package"
    :key="dict.value"
    :label="dict.value"
  >{{dict.label}}</el-radio>
</el-radio-group>
```

服务分类：

```html
<el-select v-model="form.serviceCatalog" placeholder="服务分类" clearable>
  <el-option
    v-for="dict in dict.type.bus_service_type"
    :key="dict.value"
    :label="dict.label"
    :value="dict.value"
  />
</el-select>
```

按钮逻辑

```html
<el-table-column label="操作" align="center" class-name="small-padding fixed-width">
  <template slot-scope="scope">
    <el-button
      size="mini"
      type="text"
      icon="el-icon-edit"
      @click="handleUpdate(scope.row)"
      v-hasPermi="['business:serviceItem:edit']"
      v-if="!(scope.row.auditStatus == 1 || scope.row.saleStatus==1)"
    >修改</el-button>
    <el-button
      size="mini"
      type="text"
      icon="el-icon-edit"
      v-if="scope.row.saleStatus==0"
      @click="saleOn(scope.row)"
      v-hasPermi="['business:serviceItem:edit']"
    >上架</el-button>
    <el-button
      size="mini"
      type="text"
      icon="el-icon-edit"
      v-if="scope.row.saleStatus==1"
      @click="saleOff(scope.row)"
      v-hasPermi="['business:serviceItem:edit']"
    >下架</el-button>
    <el-button
      size="mini"
      type="text"
      icon="el-icon-delete"
      @click="handleDelete(scope.row)"
      v-hasPermi="['business:serviceItem:remove']"
    >删除</el-button>
  </template>
</el-table-column>
```

#### 3.2.5.3、处理后端

后端要考虑前端有字段没有传递过来，这些字段如何处理

**实现思路:**

- 参数校验
- 判断折扣金额不能大于原价
- 判断如果是套餐设置审批状态为初始化如果是非套餐设置成无序审核
- 插入到数据库

**代码：**

```java
@Override
public int insertBusServiceItem(BusServiceItemVO busServiceItem)
{
    //做参数校验
    if(busServiceItem == null){
        throw new RuntimeException("非法操作");
    }

    //判断折扣金额不能大于总金额
    int count = busServiceItem.getDiscountPrice().compareTo(busServiceItem.getOriginalPrice());
    if(count>0){
        throw new RuntimeException("折扣金额不能大于总金额");
    }

    //判断是否是套餐,如果是套餐状态为初始化,如果不是状态为无序审核
    if(BusServiceItem.CARPACKAGE_YES.equals(busServiceItem.getCarPackage())){
        busServiceItem.setAuditStatus(BusServiceItem.AUDITSTATUS_INIT);
    }else{
        busServiceItem.setAuditStatus(BusServiceItem.AUDITSTATUS_NO_REQUIRED);
    }
    //设置创建时间
    busServiceItem.setCreateTime(DateUtils.getNowDate());
    BusServiceItem busServiceItem1 = new BusServiceItem();
    BeanUtils.copyProperties(busServiceItem,busServiceItem1);
    return busServiceItemMapper.insertBusServiceItem(busServiceItem1);
}
```

### 3.2.6、养修服务单项编辑

#### 3.2.6.1、界面效果

![image-20221124144647609](images/image-20221124144647609.png)

#### 3.2.6.2、处理前端

1、界面中套餐是不让修改的，其他内容正常回显

```java
el-form-item  v-if="form.id==null" label="是否套餐" prop="carPackage">
  <el-radio-group v-model="form.carPackage">
    <el-radio
      v-for="dict in dict.type.bus_car_package"
      :key="dict.value"
      :label="dict.value"
    >{{dict.label}}</el-radio>
  </el-radio-group>
</el-form-item>
```

#### 3.2.6.3、处理后端

实现思路：

- 参数校验
- 判断金额不能大于原价
- 如果是审核中或者是上架抛出异常
- 如果是套餐并且是审核通过修改为初始化状态
- 修改数据

代码：

```java
public int updateBusServiceItem(BusServiceItemVO busServiceItem)
{

    //做参数校验
    if(busServiceItem == null){
        throw new RuntimeException("非法操作");
    }

    BusServiceItem item = busServiceItemMapper.selectBusServiceItemById(busServiceItem.getId());
    //判断折扣金额不能大于总金额
    int count = busServiceItem.getDiscountPrice().compareTo(busServiceItem.getOriginalPrice());
    if(count>0){
        throw new RuntimeException("折扣金额不能大于总金额");
    }
    //如果是上架或者是审核中状态, 抛出异常
    if(BusServiceItem.SALESTATUS_ON.equals(item.getSaleStatus()) ||
            BusServiceItem.AUDITSTATUS_AUDITING.equals(item.getAuditStatus())){
        throw new RuntimeException("非法操作");
    }
    //判断状态如果是套餐并且是审核通过的,我们需要把状态修改成初始化
    if(BusServiceItem.CARPACKAGE_YES.equals(item.getCarPackage())
            && BusServiceItem.AUDITSTATUS_APPROVED.equals(item.getAuditStatus())){
        busServiceItem.setAuditStatus(BusServiceItem.AUDITSTATUS_INIT);
    }

    BusServiceItem busServiceItem1 = new BusServiceItem();
    BeanUtils.copyProperties(busServiceItem,busServiceItem1);
    //重新改成下架状态
    return busServiceItemMapper.updateBusServiceItem(busServiceItem1);
}
```

### 3.2.7、养修服务单项上架

需求：单项类似超时的商品，这里只有上架用户才可以消费

#### 3.2.7.1、界面效果

![image-20221124145613857](images/image-20221124145613857.png)

#### 3.2.7.2、处理前端

1、在serviceItem.js中加入

```js
export function saleOn(id) {
  return request({
    url: '/business/serviceItem/saleOn/' + id,
    method: 'put'
  })
}
```

2、在 index.vue中加入

```js
import { listServiceItem,saleOn,saleOff, getServiceItem, delServiceItem, addServiceItem, updateServiceItem } from "@/api/business/serviceItem";

```

3、添加按钮

```html
<el-button
  size="mini"
  type="text"
  icon="el-icon-edit"
  v-if="scope.row.saleStatus == 0"
  @click="saleOn(scope.row)"
  v-hasPermi="['business:serviceItem:edit']"
>上架</el-button>
```

4、添加方法

```html
saleOn(row) {
  const ids = row.id || this.ids;
  this.$modal.confirm('确定上架吗?').then(function() {
    return saleOn(ids);
  }).then(() => {
    this.getList();
    this.$modal.msgSuccess("上架成功");
  }).catch(() => {});
},
```

#### 3.2.7.3、处理后端逻辑

**实现思路：**

- 参数校验
- 判断是否是套餐状态是非审核通过抛出异常
- 修改上架状态

**代码：**

```java
@Override
public int saleOn(Long id) {
    if(id == null){
        throw new RuntimeException("非法操作");
    }
    BusServiceItem busServiceItem = busServiceItemMapper.selectBusServiceItemById(id);
    if(busServiceItem == null){
        throw new RuntimeException("非法操作");
    }

    //判断数据是否是套餐
    if(BusServiceItem.CARPACKAGE_YES.equals(busServiceItem.getCarPackage())&& !BusServiceItem.AUDITSTATUS_APPROVED.equals(busServiceItem.getAuditStatus())){
        throw new RuntimeException("套餐必须要审核通过才可以上架");
    }
    //修改上架状态
    return busServiceItemMapper.updateSaleStatus(id,BusServiceItem.SALESTATUS_ON);

}
```

### 3.2.8、养修服务单项下架

#### 3.2.8.1、界面效果
![image-20221124150220044](images/image-20221124150220044.png)

#### 3.2.8.2、处理前端
1、在serviceItem.js中加入

```js
export function saleOn(id) {
  return request({
    url: '/business/serviceItem/saleOff/' + id,
    method: 'put'
  })
}
```

2、在 index.vue中加入

```js
import { listServiceItem,saleOn,saleOff, getServiceItem, delServiceItem, addServiceItem, updateServiceItem } from "@/api/business/serviceItem";

```

3、添加按钮

```html
<el-button
  size="mini"
  type="text"
  icon="el-icon-edit"
  v-if="scope.row.saleStatus == 1"
  @click="saleOn(scope.row)"
  v-hasPermi="['business:serviceItem:edit']"
>下架</el-button>
```

4、添加方法

```js
saleOn(row) {
  const ids = row.id || this.ids;
  this.$modal.confirm('确定下架吗?').then(function() {
    return saleOff(ids);
  }).then(() => {
    this.getList();
    this.$modal.msgSuccess("下架成功");
  }).catch(() => {});
},
```

#### 3.1.8.3、处理后端逻辑

**实现思路：**

- 参数校验
- 修改状态

**代码：**

```java
@Override
public int saleOff(Long id) {
    if(id == null){
        throw new RuntimeException("非法操作");
    }
    BusServiceItem busServiceItem = busServiceItemMapper.selectBusServiceItemById(id);
    if(busServiceItem == null){
        throw new RuntimeException("非法操作");
    }
    //修改上架状态
    return busServiceItemMapper.updateSaleStatus(id,BusServiceItem.SALESTATUS_ON);
}
```

## 3.3、结算单

原型：



### 3.3.1、功能描述

客户线下消费完成之后，服务结账，列举消费了哪些项目，使用结算单进行记录。这里会分2中情况进行结算

1、如果客户直接进店消费，由客服收到录入结算单

2、如果客户通过预约，然后履约消费，由程序自动录入结算单，此时的结算的预约单id属性有值

原型：

![image-20221124151233094](images/image-20221124151233094.png)

### 3.3.2、具体需求

1、结算单列表

2、结算单添加

3、结算单编辑

4、结算单明细(明细添加/明细查看)

5、结算到删除

### 3.3.3、表设计

![image-20221124151316804](images/image-20221124151316804.png)

需要注意的字段：服务类型、预约单 id、结算单状态、总金额、总数量、折扣金额

服务类型：只有维修和保养来源于数据字典
预约单 id：这个字段是用来区分是否是通过预约方式创建的预约单
结算单状态：只有消费中和已支付来源于数据字典
总金额|总数量|折扣金额：后续要通过计算得出(占时不考虑怎么获取)

### 3.3.4、结算单列表

#### 3.3.4.1、界面效果

![image-20221124151746704](images/image-20221124151746704.png)

#### 3.3.4.2、处理前端

1、高级查询部分

```html
<el-form :model="queryParams" ref="queryForm" size="small" :inline="true" v-show="showSearch" label-width="68px">

  <el-form-item label="开始时间" prop="startTime">
    <el-date-picker clearable
                      v-model="queryParams.startTime"
                      type="date"
                      value-format="yyyy-MM-dd"
                      placeholder="开始时间">
    </el-date-picker>
  </el-form-item>

    <el-form-item label="结束时间" prop="endTime">
      <el-date-picker clearable
                      v-model="queryParams.endTime"
                      type="date"
                      value-format="yyyy-MM-dd"
                      placeholder="结束时间">
      </el-date-picker>
    </el-form-item>

  <el-form-item>
    <el-button type="primary" icon="el-icon-search" size="mini" @click="handleQuery">搜索</el-button>
    <el-button icon="el-icon-refresh" size="mini" @click="resetQuery">重置</el-button>
  </el-form-item>
</el-form>
```

2、在 data 中加入

```js
queryParams: {
  pageNum: 1,
  pageSize: 10,
  startTime:null,
  endTime:null
},
```

3、按钮部分：把多余的删除掉就可以
4、表格部分：要处理服务类型，预约，结算单状态

**5、服务类型和结算单**：来源于数据字典

Js

```js
dicts: ["bus_service_type","but_statement_status"],
```

html

```html
<el-table-column label="服务类型" align="center" prop="serviceType">
  <template slot-scope="scope">
    <dict-tag :options="dict.type.bus_service_type" :value="scope.row.serviceType"/>
  </template>
</el-table-column>
```

预约：根据是否有结算单 id来显示是或者否

```html
<el-table-column label="预约"  align="center" prop="appointmentId" >
  <template slot-scope="scope">
    <span v-if="scope.row.appointmentId>0">是</span>
    <span v-if="scope.row.appointmentId==null">否</span>
  </template>
</el-table-column>
```

#### 3.3.4.3、处理后端

后端跟一样没什么变化

**实例类**：

```java
@Getter
@Setter
@ToString
public class BusStatement extends BaseEntity
{
    public static final String STATUS_CONSUME = "0";//消费中
    public static final String STATUS_PAID = "1";//已支付
    private static final long serialVersionUID = 1L;

    /** $column.columnComment */
    private Long id;

    /** 客户姓名 */
    @Excel(name = "客户姓名")
    private String customerName;

    /** 客户联系方式 */
    @Excel(name = "客户联系方式")
    private String customerPhone;

    /** 实际到店时间 */
    @JsonFormat(pattern = "yyyy-MM-dd")
    @Excel(name = "实际到店时间", width = 30, dateFormat = "yyyy-MM-dd")
    private Date actualArrivalTime;

    /** 车牌号码 */
    @Excel(name = "车牌号码")
    private String licensePlate;

    /** 汽车类型 */
    @Excel(name = "汽车类型")
    private String carSeries;

    /** 服务类型【维修/保养】 */
    @Excel(name = "服务类型【维修/保养】")
    private String serviceType;

    /** 预约单ID【通过这个来判断是否预约用户,唯一标识】 */
    @Excel(name = "预约单ID【通过这个来判断是否预约用户,唯一标识】")
    private Long appointmentId;

    /** 结算状态【消费中0/已支付1】 */
    @Excel(name = "结算状态【消费中0/已支付1】")
    private String status;

    /** 收款时间 */
    @JsonFormat(pattern = "yyyy-MM-dd")
    @Excel(name = "收款时间", width = 30, dateFormat = "yyyy-MM-dd")
    private Date payTime;

    /** 收款人id */
    @Excel(name = "收款人id")
    private Long payeeId;

    /** 总消费金额 */
    @Excel(name = "总消费金额")
    private BigDecimal totalAmount;

    /** 服务项数量 */
    @Excel(name = "服务项数量")
    private BigDecimal totalQuantity;

    /** 折扣金额 */
    @Excel(name = "折扣金额")
    private BigDecimal discountAmount;

    /** 备注信息 */
    @Excel(name = "备注信息")
    private String info;

    /** $column.columnComment */
    private Integer isDelete;


}
```

#### 3.3.4.4、日期高级查询

前端发送请求传递 startTime 和 endTime ，后端还要考虑接受进行高级查询

步骤 1： 添加StatementQuery

```java
@Getter
@Setter
public class StatementQuery  {

    @JsonFormat(pattern = "yyyy-MM-dd")
    private Date startTime;
    @JsonFormat(pattern = "yyyy-MM-dd")
    private Date endTime;

    public Date getEndTime(){
        Calendar calendar = Calendar.getInstance();
        if(endTime!=null){
            calendar.setTime(endTime);
            calendar.add(Calendar.DAY_OF_MONTH,1);
            return calendar.getTime();
        }
        return null;
    }

}
```

步骤 2：处理 sql 的条件

```sql
<select id="selectBusStatementList" parameterType="BusStatement" resultMap="BusStatementResult">
    <include refid="selectBusStatementVo"/>
    <where>
        <if test="startTime != null ">
            and actual_arrival_time &gt; #{startTime}
        </if>
        <if test="endTime != null ">
            and actual_arrival_time &lt; #{endTime}
        </if>
    </where>
</select>
```

> 问题:  这里有个问题就是查询同一天的数据发现查不到？
> 问题原因：由于没有传递时分秒导致开始时间都是 0 时 0 分 0 秒
> 解决：自己处理 getEndTime方法让天数+1



### 3.3.5、结算单新增

#### 3.3.5.1、界面效果

![image-20221126142908766](images/image-20221126142908766.png)

#### 3.3.5.2、处理前端

1、把多余字段删除掉

2、 服务类型来源于数据字典

```html
<el-dialog :title="title" :visible.sync="open" width="500px" append-to-body>
  <el-form ref="form" :model="form" :rules="rules" label-width="120px">
    <el-form-item label="客户姓名" prop="customerName">
      <el-input v-model="form.customerName" placeholder="请输入客户姓名" />
    </el-form-item>
    <el-form-item label="客户联系方式" prop="customerPhone">
      <el-input v-model="form.customerPhone" placeholder="请输入客户联系方式" />
    </el-form-item>
    <el-form-item label="实际到店时间" prop="actualArrivalTime">
      <el-date-picker clearable
        v-model="form.actualArrivalTime"
        type="date"
        value-format="yyyy-MM-dd"
        placeholder="请选择实际到店时间">
      </el-date-picker>
    </el-form-item>
    <el-form-item label="车牌号码" prop="licensePlate">
      <el-input v-model="form.licensePlate" placeholder="请输入车牌号码" />
    </el-form-item>
    <el-form-item label="汽车类型" prop="carSeries">
      <el-input v-model="form.carSeries" placeholder="请输入汽车类型" />
    </el-form-item>
    <el-form-item label="服务类型" prop="serviceType">
      <el-select v-model="form.serviceType" placeholder="服务类型" clearable>
        <el-option
          v-for="dict in dict.type.bus_service_type"
          :key="dict.value"
          :label="dict.label"
          :value="dict.value"
        />
      </el-select>
    </el-form-item>

    <el-form-item label="备注信息" prop="info">
      <el-input v-model="form.info" placeholder="请输入备注信息" />
    </el-form-item>

  </el-form>
  <div slot="footer" class="dialog-footer">
    <el-button type="primary" @click="submitForm">确 定</el-button>
    <el-button @click="cancel">取 消</el-button>
  </div>
</el-dialog>
```

#### 3.3.5.3、处理后端逻辑

实现思路：

- 参数校验
- 手机格式校验
- 车牌号校验
- 到店时间必须要当天之后
- 新增操作

代码：

```java
@Override
public int insertBusStatement(BusStatementVO busStatement)
{
    if(busStatement == null){
        throw new RuntimeException("非法操作");
    }
    BusStatement bus = busStatementMapper.selectBusStatementById(busStatement.getId());
    //做手机号码校验
    boolean phoneLegal = RegexUtils.isPhoneLegal(busStatement.getCustomerPhone());
    if(!phoneLegal){
        throw new RuntimeException("手机号码不正确");
    }
    //车牌号码校验
    VehiclePlateNoUtil.VehiclePlateNoEnum vehiclePlateNo = VehiclePlateNoUtil.getVehiclePlateNo(busStatement.getLicensePlate());
    if(vehiclePlateNo == null){
        throw new RuntimeException("车牌号不正确");
    }
    //做日期校验
    boolean flag = busStatement.getActualArrivalTime().before(new Date());
    if(flag){
        throw new RuntimeException("日期时间不对");
    }

    BusStatement busStatement1 = new BusStatement();
    BeanUtils.copyProperties(busStatement,busStatement1);
    busStatement1.setCreateTime(DateUtils.getNowDate());
    busStatement1.setStatus(BusStatement.STATUS_CONSUME);

    return busStatementMapper.insertBusStatement(busStatement1);
}
```

=

### 3.3.6、结算单编辑

#### 3.3.6.1、界面效果

![image-20221126143751156](images/image-20221126143751156.png)

#### 3.3.6.2、处理后端逻辑

实现思路：

- 参数校验
- 状态验证必须要在消费中
- 手机格式校验
- 车牌号校验
- 到店时间必须要当天之后
- 修改数据

代码:

```java
@Override
public int insertBusStatement(BusStatementVO busStatement)
{
    if(busStatement == null){
        throw new RuntimeException("非法操作");
    }
    //判断必须要是消费中才可以修改
    BusStatement bus = busStatementMapper.selectBusStatementById(busStatement.getId());
    if(!bus.getStatus().equals(BusStatement.STATUS_CONSUME)){
        throw new RuntimeException("必须要处于消费中状态");
    }
    //做手机号码校验
    boolean phoneLegal = RegexUtils.isPhoneLegal(busStatement.getCustomerPhone());
    if(!phoneLegal){
        throw new RuntimeException("手机号码不正确");
    }
    //车牌号码校验
    VehiclePlateNoUtil.VehiclePlateNoEnum vehiclePlateNo = VehiclePlateNoUtil.getVehiclePlateNo(busStatement.getLicensePlate());
    if(vehiclePlateNo == null){
        throw new RuntimeException("车牌号不正确");
    }
    //做日期校验
    boolean flag = busStatement.getActualArrivalTime().before(new Date());
    if(flag){
        throw new RuntimeException("日期时间不对");
    }

    BusStatement busStatement1 = new BusStatement();
    BeanUtils.copyProperties(busStatement,busStatement1);
    busStatement1.setCreateTime(DateUtils.getNowDate());
    busStatement1.setStatus(BusStatement.STATUS_CONSUME);

    return busStatementMapper.insertBusStatement(busStatement1);
}
```

### 3.3.7、结算单删除

实现思路：

- 参数校验
- 修改isDelete状态为 1
- 把查询数据的 sql 加条件 isDelete=0
- 删除结算单明细
- 判断是否是预约单生成的结算单，如果是把预约单状态修改成到店状态

代码实现：

service:

```java
 @Transactional
    public void deleteBusStatementByIds(Long id)
    {
        //做参数校验
        if(id == null){
            throw new RuntimeException("非法操作");
        }
        BusStatement statement = busStatementMapper.selectBusStatementById(id);
        if(statement ==  null){
            throw new RuntimeException("非法操作");
        }
        busStatementMapper.updateStatementDeleteStatus(id,1);
        //删除关系
        busStatementMapper.deleteRelation(id);
        //判断预约单 id 是否为 null
        if(statement.getAppointmentId() != null){
            appointmentMapper.updateAuditStatus(statement.getId(), BusAppointment.STATUS_ARRIVAL);
        }
    }
```

Xml:

```sql
<update id="updateStatementDeleteStatus">
    update bus_statement set is_delete = #{status} where id = #{id}
</update>

<select id="selectBusStatementList" parameterType="BusStatement" resultMap="BusStatementResult">
        <include refid="selectBusStatementVo"/>
        <where>
             is_delete = 0
        </where>
    </select>
    
 <delete id="deleteRelation">
        delete from bus_statement_item where statement_id = #{id}
    </delete>
```

### 3.3.8、结算单明细

#### 3.3.8.1、表设计

bus_statement_item

![image-20221126145310426](images/image-20221126145310426.png)

思考：

问题1：结算单和服务单项之间的关系
问题 2：为什么中间表会设计添加服务价格这些字段

#### 3.3.8.2、界面效果

消费中：

![image-20221126145601734](images/image-20221126145601734.png)

已支付：

![image-20221127153053941](images/image-20221127153053941.png)

#### 3.3.8.3、前端处理

前端流程：这里点击明细按钮会进入到明细界面，如果数据是消费中看到的是消费明细界面，如果是已支付是详情界面

1、处理按钮

```html
  <el-button
            size="mini"
            type="text"
            icon="el-icon-notebook-2"
            @click="handleDetail(scope.row)"
            v-hasPermi="['business:statementItem:list']"
            >明细</el-button
          >
```

2、js 处理

```js
  handleDetail(row){
        const id =row.id;
        this.$router.push({
            path:"/business/statement/item",query:{id}
        });
    }
  },
```

3、添加路由信息在 index.js

```js
  {
    path: '/business',
      component: Layout,
      hidden: true,
      redirect: 'noredirect',
      children: [
      {
        path: 'statement/item',
        component: () => import('@/views/business/statement/item')
      }
  ]
}
```

4、在 statement 目录下创建一个 item 目录，在创建一个 index.vue文件

5、界面内容分析

整个界面数据一共分成三部分：

第一部分：结算单数据区，这部分需要发送请求根据结算单 id 去查询数据
第二部分按钮区域
第三部分：结算单表格明细部分， 这部分也是需要发送请求去查询数据
第死部分：服务单项部分，发送请求查询上架的单项数据

6、界面状态显示

**整个界面是根据结算单的状态来进行决定显示那一块内容的**

如果是消费中：服务单项区域会显示，结算单数据会显示，按钮区显示，消费明细表格胡显示。
如果是已支付：结算单数据会显示，消费明细表格显示，其他均不显示



代码：

结算单内容显示

```js
 // 用户信息
  getStatement(this.id).then((response) => {
    this.discountAmount = response.data.discountAmount;
    this.customer = response.data;
    this.customer.status = parseInt(response.data.status);
    //处理服务类类型显示问题
    // this.customer.serviceCatalog=this.customer.serviceCatalog.toString();
  });
```

服务单项列表显示

```js

   // 获取服务单项列表
  listServiceItem(this.queryParams).then((response) => {
    this.serviceItemList = response.rows;
  });
```

结算单明列表显示

```js
// 消费列表
listStatementItem(this.itemQueryParams).then((response) => {
  console.log(this.itemQueryParams)
  this.total = response.total;
  this.consumptionList = response.rows;
});
```

导入

```js
import { getStatement} from "@/api/business/statement";
import {addStatementItem,listStatementItem,payStatement} from "@/api/business/statementItem";
import {listServiceItem } from "@/api/business/serviceItem";
```

创建 statementItem.js文件

```js
import request from '@/utils/request'


// 新增结算单
export function addStatementItem(data) {
  return request({
    url: '/business/statementItem',
    method: 'post',
    data: data
  })
}

// 新增结算单
export function listStatementItem(data) {
  return request({
    url: '/business/statementItem/list',
    method: 'get',
    params: data
  })
}


export function payStatement(id) {
  return request({
    url: '/business/statementItem/pay/'+id,
    method: 'put',
  })
}
```

完整界面：

```html
<template>
  <div>
    <el-container>
      <el-main>
        <el-row>
          <el-col :span="customer.status ? 24 : 16" class="height-handle">
            <!-- 客户信息 -->
            <el-row :span="24" class="customer_info">
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">客户姓名: </el-col>
                  <el-col :span="12">{{ customer.customerName }}</el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">联系方式: </el-col>
                  <el-col :span="12">{{ customer.customerPhone }}</el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">车牌号码：</el-col>
                  <el-col :span="12">{{ customer.licensePlate }}</el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">汽车类型：</el-col>
                  <el-col :span="12">{{ customer.carSeries }}</el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">服务类型：</el-col>
                  <el-col :span="12">
                    <dict-tag
                      :options="dict.type.si_service_catalog"
                      :value="customer.serviceCatalog"
                    >
                    </dict-tag>
                  </el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">到店时间：</el-col>
                  <el-col :span="12">{{ customer.actualArrivalTime }}</el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">总消费金额：</el-col>
                  <el-col :span="12" v-if="customer.status">{{
                    customer.totalAmount
                    }}</el-col>
                  <el-col :span="12" v-else>{{ totalSum }}</el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">实付价格： </el-col>
                  <el-col :span="12" v-if="customer.status"
                  >{{ customer.totalAmount - customer.discountAmount }}
                  </el-col>
                  <el-col :span="12" v-else>{{ actualPrice }}</el-col>
                </div>
              </el-col>
              <el-col :span="12">
                <div class="form-group">
                  <el-col :span="12">优惠价格：</el-col>
                  <el-col :span="12" v-if="customer.status">{{
                    customer.discountAmount
                    }}</el-col>
                  <el-col :span="12" v-else>
                    <el-input
                      size="mini"
                      v-model="discountAmount"
                      :min="0"
                      :max="totalSum"
                      @blur="discountAmountHandle"
                    >
                    </el-input>
                  </el-col>
                </div>
              </el-col>
            </el-row>
            <!-- 服务项列表 -->
            <el-row :span="24" class="service_item_box">
              <el-row :gutter="10" class="mb8">
                <el-col :span="6" v-if="!customer.status">
                  <el-button
                    type="primary"
                    plain
                    icon="el-icon-plus"
                    size="mini"
                    @click="save"
                  >保存</el-button
                  >
                  <el-button
                    type="warning"
                    plain
                    icon="el-icon-plus"
                    size="mini"
                    @click="pay"
                  >支付</el-button
                  >
                </el-col>
                <right-toolbar @queryTable="getDetail"></right-toolbar>
              </el-row>
              <el-table :data="consumptionList" style="width: 100%">
                <el-table-column prop="itemName" label="服务名称">
                </el-table-column>
                <el-table-column prop="itemPrice" label="服务价格">
                </el-table-column>
                <el-table-column prop="itemQuantity" label="数量">
                </el-table-column>
                <el-table-column
                  label="操作"
                  align="center"
                  v-if="!customer.status"
                >
                  <template slot-scope="scope">
                    <el-button
                      size="mini"
                      icon="el-icon-plus"
                      type="primary"
                      @click="plusHandle(scope.$index)"
                    >
                    </el-button>
                    <el-button
                      size="mini"
                      icon="el-icon-minus"
                      type="danger"
                      @click="minusHandle(scope.$index)"
                    >
                    </el-button>
                  </template>
                </el-table-column>
              </el-table>

              <div class="page">
                显示第 1 到第 {{ consumptionList.length }} 条记录，总共
                {{ consumptionList.length }} 条记录
              </div>
            </el-row>
          </el-col>
          <el-col :span="8" v-if="!customer.status" class="height-handle">
            <!-- 服务项搜索 -->
            <el-row>
              <el-col :span="24" class="serach_box">
                <el-form ref="form" :model="queryParams" label-width="100px">
                  <el-form-item label="名称：">
                    <el-input v-model="queryParams.name" clearable></el-input>
                  </el-form-item>
                  <el-form-item label="是否套餐：">
                    <el-select v-model="queryParams.carPackage" clearable>
                      <el-option
                        v-for="dict in dict.type.bus_car_package"
                        :key="dict.value"
                        :label="dict.label"
                        :value="dict.value"
                      />
                    </el-select>
                  </el-form-item>
                  <el-form-item label="服务分类：">
                    <el-select v-model="queryParams.serviceCatalog" clearable>
                      <el-option
                        v-for="dict in dict.type.bus_service_type"
                        :key="dict.value"
                        :label="dict.label"
                        :value="dict.value"
                      ></el-option>
                    </el-select>
                  </el-form-item>
                  <el-form-item>
                    <el-button
                      type="success"
                      icon="el-icon-search"
                      round
                      @click="search"
                    >搜索</el-button
                    >
                  </el-form-item>
                </el-form>
              </el-col>
            </el-row>
            <!-- 服务项显示 -->
            <el-row>
              <el-col :span="24" class="service_list_box">
                <el-table :data="serviceItemList" style="width: 100%">
                  <el-table-column prop="name" label="服务名称">
                  </el-table-column>
                  <el-table-column prop="originalPrice" label="服务价格">
                  </el-table-column>
                  <el-table-column label="操作">
                    <template slot-scope="scope">
                      <el-button
                        size="mini"
                        icon="el-icon-plus"
                        type="primary"
                        @click="serviceItemPlus(scope.row)"
                      ></el-button>
                    </template>
                  </el-table-column>
                </el-table>
                <div class="page">
                  显示第 1 到第 {{ serviceItemList.length }} 条记录，总共
                  {{ serviceItemList.length }} 条记录
                </div>
              </el-col>
            </el-row>
          </el-col>
        </el-row>
      </el-main>
    </el-container>
  </div>
</template>
<script>
  import { getStatement, payStatement } from "@/api/business/statement";
  // import {addStatementItem,listStatementItem,} from "@/api/business/statementitem";
  import { listItem } from "@/api/business/serviceItem";
  export default {
    name: "StatementItem",
    dicts: ["bus_service_type", "bus_car_package", "bus_service_type"],
    data() {
      return {
        //优惠价格
        discountAmount: 0,
        //结算单Id
        id: this.$route.query.id,
        // 用户信息
        customer: {},
        // 查询参数
        queryParams: {
          saleStatus: 1,
          pageNum: 1,
          pageSize: 5,
          name: undefined,
          carPackage: undefined,
          serviceCatalog: undefined,
        },
        //消费参数
        itemQueryParams: {
          statementId: this.$route.query.id,
          pageNum: 1,
          pageSize: 5,
        },
        //已消费总数
        total: 0,
        //消费服务项
        serviceItemList: [],
        //消费服务项
        consumptionList: [],
      };
    },
    created() {
      // this.getDetail();
    },
    methods: {
      getDetail() {
        // 用户信息
        getStatement(this.id).then((response) => {
          this.discountAmount = response.data.discountAmount;
          this.customer = response.data;
          //处理服务类类型显示问题
          // this.customer.serviceCatalog=this.customer.serviceCatalog.toString();
        });
        // 获取服务单项列表
        listItem(this.queryParams).then((response) => {
          this.serviceItemList = response.rows;
        });
        // 消费列表
        listStatementItem(this.itemQueryParams).then((response) => {
          this.total = response.total;
          this.consumptionList = response.rows;
        });
      },
      //搜索按钮
      search() {
        // 获取服务单项列表
        listItem(this.queryParams).then((response) => {
          this.serviceItemList = response.rows;
        });
      },
      //服务单项添加按钮
      serviceItemPlus(row) {
        let idx = this.searchServiceItemIndex(row);
        if (idx != -1) {
          //更新数量
          this.consumptionList[idx].itemQuantity++;
        } else {
          //添加服务项
          this.consumptionList.push(this.serviceItem(row));
        }
      },
      //服务项是否已经添加服务列表了
      searchServiceItemIndex(row) {
        let idx = -1;
        if (this.consumptionList.length < 1) {
          return -1;
        }
        this.consumptionList.forEach((item, index) => {
          if (item.itemId == row.id) {
            idx = index;
            return;
          }
        });
        return idx;
      },
      //服务单项数据处理
      serviceItem(row) {
        return {
          statementId: this.id,
          itemId: row.id,
          itemName: row.name,
          itemPrice: row.originalPrice,
          itemQuantity: 1,
        };
      },
      // 服务项目数量增加按钮操作
      plusHandle(index) {
        this.consumptionList[index].itemQuantity++;
      },
      //服务项目数量减按钮操作
      minusHandle(index) {
        if (this.consumptionList[index].itemQuantity <= 1) {
          this.consumptionList.splice(index, 1);
          return;
        }
        this.consumptionList[index].itemQuantity--;
        // 减去商品后，实际价格为负数
        this.actualPriceHandle();
      },
      //保存服务选项按钮
      save() {
        let data={
          "busStatementItems":this.consumptionList,
          "discountPrice":this.discountAmount
        }
        addStatementItem(data).then(response=>{
          this.$modal.msgSuccess(response.msg);
          this.getDetail();
        })
      },
      //支付按钮操作
      pay() {
        payStatement(this.id).then(response=>{
          this.$modal.msgSuccess(response.msg);
          this.getDetail();
        })
      },
      //优惠价格
      discountAmountHandle() {
        if (this.discountAmount > this.totalSum || this.discountAmount < 0) {
          this.$alert("输入优惠价格有误", {
            confirmButtonText: "确定",
            callback: (action) => {
              this.discountAmount = 0;
            },
          });
        }
      },
      actualPriceHandle() {
        if (this.actualPrice < 0) {
          this.$alert("实际价格为负数,重置优惠价格", {
            confirmButtonText: "确定",
            callback: (action) => {
              this.discountAmount = 0;
            },
          });
        }
      },
    },
    computed: {
      //实时计算总价格
      totalSum() {
        let total = 0;
        this.consumptionList.forEach((item) => {
          total += item.itemPrice * item.itemQuantity;
        });
        return total;
      },
      // 真实价格处理:总价格减去折扣价
      actualPrice() {
        return this.totalSum - this.discountAmount;
      },
    },
  };
</script>

<style lang="scss" scoped>
  .customer_info {
    background-color: #fff;
    border-radius: 6px;
    padding-top: 5px;
    padding-bottom: 13px;
    box-shadow: 1px 1px 3px rgb(0 0 0 / 20%);
    padding-left: 45px;
    color: #333;
    font-size: 14px;

    .form-group {
      line-height: 25px;
    }
  }

  .service_item_box {
    background: #fff;
    border-radius: 6px;
    margin-top: 10px;
    box-shadow: 1px 1px 3px rgb(0 0 0 / 20%);
    padding: 15px;
  }

  .serach_box {
    width: 100%;
    background: #fff;
    border-radius: 6px;
    margin-left: 15px;
    padding-top: 5px;
    box-shadow: 1px 1px 3px rgb(0 0 0 / 20%);

    .el-input {
      max-width: 217px;
    }
  }

  .service_list_box {
    width: 100%;
    background: #fff;
    border-radius: 6px;
    margin-top: 10px;
    padding: 15px;
    box-shadow: 1px 1px 3px rgb(0 0 0 / 20%);
    margin-left: 15px;
  }

  .page {
    line-height: 34px;
    font-size: 13px;
    color: #676a6c;
  }

  .el-form-item {
    margin-bottom: 15px;
  }
</style>
```

>注：这个界面内容能看懂在做什么就可以了，我们更专注于后端的逻辑

#### 3.3.8.4、结算单明细新增

需求：前端点击新增按钮，把结算单明细最终保存到数据库中， 同时还需要修改结算总金额，折扣金额，总数量。

##### 3.3.8.4.1、前端处理

当点击保存按钮需要发送请求，把明细表格中的数据和折扣金额传递到后台

```js
//保存服务选项按钮
save() {
  let data={
    "busStatementItems":this.consumptionList,
    "discountPrice":this.discountAmount
  }
  addStatementItem(data).then(response=>{
    this.$modal.msgSuccess(response.msg);
    this.getDetail();
  })
},
```

在statementItem.js中加入

```js
// 新增结算单
export function addStatementItem(data) {
  return request({
    url: '/business/statementItem',
    method: 'post',
    data: data
  })
}
```

##### 3.3.8.4.2、后端处理

实现思路：

- 考虑如何接受参数
- 进行参数合理化校验
- 获取结算单 id
- 判断状态是否为消费中
- 根据结算单id去明细表查询数据，如果有就删除
- 循环遍历计算总金额，总数量
- 判断折扣金额是否大于总金额
- 更新结算单中总金额总数量折扣金额

vo:

```java
@Getter
@Setter
public class BusStatementItemVO {
    private BigDecimal discountPrice;
    private List<BusStatementItem> busStatementItems;
}
```

代码：

```java
@Override
@Transactional
public void insertBusStatementItem(BusStatementItemVO busStatementItem)
{

    //1.做参数校验
    if(busStatementItem == null){
        throw new RuntimeException("非法操作");
    }
    if(busStatementItem.getDiscountPrice() == null){
        throw new RuntimeException("非法操作");
    }
    if(busStatementItem.getBusStatementItems()==null){
        throw new RuntimeException("非法操作");
    }
    //2.获取结算单 id,根据结算单 id 查询数据
    List<BusStatementItem> busStatementItems = busStatementItem.getBusStatementItems();
    BusStatementItem item = busStatementItems.get(0);
    Long statementId = item.getStatementId();
    BusStatement statement = statementMapper.selectBusStatementById(statementId);
    if(statement == null){
        throw new RuntimeException("非法操作");
    }
    //3.判断状态是否有消费中
    if(!BusStatement.STATUS_CONSUME.equals(statement.getStatus())){
        throw new RuntimeException("状态必须为消费中状态");
    }
    //4 根据结算单 id 去查询是否有明细,如果有就删除
    List<BusStatementItem> items = busStatementItemMapper.selectByStatementId(statementId);
    if(!StringUtils.isEmpty(items)){
        busStatementItemMapper.deleteBusStatementItemById(statementId);
    }
    BigDecimal totalAmount =  new BigDecimal("0");
    Long totalQuantity = 0L;
    //5.循环遍历
    for (BusStatementItem statementItem : busStatementItems) {
        //5.1.计算总金额
        totalAmount = totalAmount.add(statementItem.getItemPrice().multiply(new BigDecimal(statementItem.getItemQuantity())));
        //5.2.计算总数量
        totalQuantity += statementItem.getItemQuantity();
        //5.3.插入明细
        busStatementItemMapper.insertBusStatementItem(statementItem);
    }

    //6.判断折扣金额不能大于总金额
    int count = busStatementItem.getDiscountPrice().compareTo(totalAmount);
    if(count>0){
        throw new RuntimeException("折扣金额不能大于总金额");
    }
    //7.更新结算单,总金额,总数量,折扣金额
    statementMapper.updateAmount(statementId,totalAmount,totalQuantity,busStatementItem.getDiscountPrice());


}
```

#### 3.3.8.5、结算单明细支付

需求：用户已经支付， 收款人在平台中点击支付按钮，修改用户结算单的状态为支付状态，同时修改收款人和收款时间。

##### 3.3.8.5.1、处理前端

发送请求

```js
//支付按钮操作
pay() {
  payStatement(this.id).then(response=>{
    this.$modal.msgSuccess("支付成功");
    this.getDetail();
  })
},
```

在 statementItem.js中加入

```js
export function payStatement(id) {
  return request({
    url: '/business/statementItem/pay/'+id,
    method: 'put',
  })
}
```

##### 3.3.8.5.2、处理后端

实现思路：

- 参数校验
- 判断状态是否为消费中状态
- 获取当前用户 id
- 更新状态

代码：

```java
@Override
@Transactional
public void pay(Long id) {
    //参数校验
    if(id == null){
        throw new RuntimeException("非法参数");
    }
    //根据 id 查询数据
    BusStatement statement = statementMapper.selectBusStatementById(id);
    //判断状态必须为消费中
    if(!BusStatement.STATUS_CONSUME.equals(statement.getStatus())){
        throw new RuntimeException("状态必须消费中");
    }
    //修改收款人, 收款时间 ,状态
    Long userId = SecurityUtils.getUserId();
    statementMapper.updatePayStatus(id,userId,BusStatement.STATUS_PAID);
    //判断是否是养修预约生成的结算单, 如果是修改状态为已支付状态
    if(statement.getAppointmentId() != null){
        appointmentMapper.updateAuditStatus(statement.getAppointmentId(), BusAppointment.STATUS_PAYED);
    }

}
```

### 3.3.9、预约单中结算单

需求：用户 通过预约单中是可以生成结算单，前端点击结算单按钮，像后台发送请求，后台需要创建结算单，然后返回结算单 id。

#### 3.3.9.1、界面效果

![image-20221126151024533](images/image-20221126151024533.png)

#### 3.3.9.2、前端处理

1、前端需要处理状态：只有在到店状态、结算单生成、已支付状态才可以点击

```html
  <el-button
            size="mini"
            type="text"
            icon="el-icon-delete"
            v-if="
              scope.row.status === 1 ||
              scope.row.status === 4 ||
              scope.row.status === 5
            "
            @click="handleStatement(scope.row)"
          >
            结算单
          </el-button>
```

2、在 appointment.js文件中添加请求

```js
export function generateStatement(id) {
  return request({
    url: '/business/statement/generate/' + id,
    method: 'put',
  })
}
```

3、在 index.vue中 import 导入

4、处理 js

```
handleStatement(row) {
      const id = row.id;
      let _this= this;
      this.$modal.confirm("是否需要生成结算单?")
      .then(function(){
        return generateStatement(id);
      })
      .then((response)=>{
        _this.$router.push({
          path: "/business/statement/item",
          query:{id: response.data}
        })
      })
    },
```

#### 3.3.9.3、处理后端逻辑

实现思路：

- 参数校验
- 状态判断
- 根据预约单 id 去查询结算单的数据
- 如果为空需要创建结算单
- 修改结算单状态为结算单生成状态

代码：

```java
@Override
public Long generate(Long id) {
    //判断参数是否为空
    if(id == null){
        throw new RuntimeException("非法参数");
    }
    //根据 id 查询数据
    BusAppointment busAppointment = busAppointmentMapper.selectBusAppointmentById(id);
    if(busAppointment == null){
        throw new RuntimeException("非法操作");
    }
    //判断状态是否为到店状态
    if(!(BusAppointment.STATUS_ARRIVAL.equals(busAppointment.getStatus())||
            BusAppointment.STATUS_PAYED.equals(busAppointment.getStatus())||
            BusAppointment.STATUS_SETTLE.equals(busAppointment.getStatus()))){
        throw new RuntimeException("非法操作");
    }
    //根据预约单 id 查询结算单数据,如果为空创建结算单
    BusStatement statement = statementMapper.queryByAppointmentId(id);
    if(statement == null){
        statement = new BusStatement();
        BeanUtils.copyProperties(busAppointment,statement);
        statement.setId(null);
        statement.setStatus(BusStatement.STATUS_CONSUME);
        statement.setAppointmentId(id);
        statementMapper.insertBusStatement(statement);
    }
    //把状态修改成结算单生成状态
    busAppointmentMapper.updateAuditStatus(id,BusAppointment.STATUS_SETTLE);

    return statement.getId();
}
```

## 3.4、Springboot集成activiti7

### 3.4.1、加入依赖

```xml
<!--添加activiti和SpringBoot整合的依赖
    MyBatis版本会有冲突，所以需要排除-->
<dependency>
    <groupId>org.activiti</groupId>
    <artifactId>activiti-spring-boot-starter</artifactId>
    <version>7.0.0.SR1</version>
    <exclusions>
        <exclusion>
            <artifactId>mybatis</artifactId>
            <groupId>org.mybatis</groupId>
        </exclusion>
    </exclusions>
</dependency>
<!--activiti可以绘制流程的的依赖-->
<dependency>
    <groupId>org.activiti</groupId>
    <artifactId>activiti-image-generator</artifactId>
    <version>7.0.0.SR1</version>
</dependency>
```

### 3.4.3：配置`application.yml`配置文件

在`application.yml`配置文件中添加Activiti7的配置信息

```yaml
spring:
  activiti:
    database-schema-update: true
    db-history-used: true
    history-level: full
    check-process-definitions: false
    use-strong-uuids: false
```

- database-schema-update属性

  ```
  1.flase：默认值。activiti在启动时，对比数据库表中保存的版本，如果没有表或者版本不匹配，将抛出异常
  2.true： activiti会对数据库中所有表进行更新操作。如果表不存在，则自动创建
  3.create_drop： 在activiti启动时创建表，在关闭时删除表（必须手动关闭引擎，才能删除表）
  4.drop-create： 在activiti启动时删除原来的旧表，然后在创建新表（不需要手动关闭引擎）
  ```

- db-history-used

  ```
  检测历史表是否存在 activiti7默认没有开启数据库历史记录,true启动数据库历史记录
  ```

- history-level

  ```
  #记录历史等级 可配置的历史级别有none, activity, audit, full
  1.none：不保存任何的历史数据，因此，在流程执行过程中，这是最高效的。
  2.activity：级别高于none，保存流程实例与流程行为，其他数据不保存。
  3.audit：除activity级别会保存的数据外，还会保存全部的流程任务及其属性。audit为history的默认值。
  4.full：保存历史数据的最高级别，除了会保存audit级别的数据外，还会保存其他全部流程相关的细节数据，包括一些流程参数等。
  ```

- check-process-definitions

  ```
  #校验流程文件，默认校验resources下的processes文件夹里的流程文件
  ```

- use-strong-uuids

  ```
  是否使用UUID作为主键生成策略
  ```

### 3.4.4、解决冲突

在 application.yml中加入，我们导入的依赖中的 bean 和之前依赖中的 bean 冲突

```yaml
spring:
  main:
  allow-bean-definition-overriding: true
```

解决表不存在的问题，这是由于 mysql 驱动 8点几的版本检查 mysql 连接下所有的数据中是否有 activiti 的表，如果有就不帮我们创建

在连接 url 中加入nullCatalogMeansCurrent=true

## 3.5、审核流程定义

### 3.5.1、功能描述

上面也说了，可以消费结算单项里面有普通项，有套餐，普通单项不需要审核。因为套餐有优惠折扣跟最终定价，这就要求必须经过店长拍板才行，所以需要引入审核流程。而这里是对流程文件上传管理

原型：

![image-20221129114606794](images/image-20221129114606794.png)

### 3.5.2、具体需求

1、流程定义列表

2、流程文件部署

3、流程定义撤销

4、查看流程文件-xml

6、查看流程文件-png

### **3.5.3、表设计**

思考：流程定义表应该怎么设计？

bus_bpmn_info

![image-20221129115005523](images/image-20221129115005523.png)

需要注意字典：bpmn_type ->来源于数据字典，process_defintion->流程定义 key

### 3.5.4、流程定义列表

准备工作：

- 需要先创建目录和菜单，步骤和之前是一样的
- 添加数据字典

#### 3.5.4.1、前端效果

![image-20221129114606794](images/image-20221129114606794.png)

#### 3.5.4.2、处理前端

高级查询部分：保留开始时间，结束时间，和审批类型

按钮部分：保留流程文件部署按钮

表格部分：把多余字段删除，处理类型显示问题

#### 3.5.4.3、处理后端

设计表之后，根据代码生成器创建 domain、mapper、xml、service…..

```java
@Getter
@Setter
public class BusBpmnInfo extends BaseEntity
{
    private static final long serialVersionUID = 1L;

    /** 主键 */
    private Long id;

    /** 流程名称 */
    @Excel(name = "流程名称")
    private String bpmnLabel;

    /** 流程类型 */
    @Excel(name = "流程类型")
    private Integer bpmnType;

    /** activity流程定义生成的key */
    @Excel(name = "activity流程定义生成的key")
    private String processDefinitionKey;

    /** 部署时间 */
    @JsonFormat(pattern = "yyyy-MM-dd")
    @Excel(name = "部署时间", width = 30, dateFormat = "yyyy-MM-dd")
    private Date deployTime;

    /** 版本号 */
    @Excel(name = "版本号")
    private Long version;

    /** 描述信息 */
    @Excel(name = "描述信息")
    private String info;

   
}
```

### 3.5.6、流程文件部署

需求：将选中的流程文件部署到 activiti 中保存起来，为后续服务单项审批做铺垫

#### 3.5.6.1、前端效果

![image-20221130142350469](/Users/fanjialong/Documents/备课视频/最新项目课件整理/11-carO2O/讲义/image-20221130142350469.png)

#### 3.5.6.2、前端处理

index.vue文件

```html
<template>
  <div class="app-container">
    <el-form :model="queryParams" ref="queryForm" size="small" :inline="true" v-show="showSearch" label-width="68px">
      <el-form-item label="开始时间" prop="startTime">
        <el-date-picker clearable
                        v-model="queryParams.startTime"
                        type="date"
                        value-format="yyyy-MM-dd"
                        placeholder="开始时间">
        </el-date-picker>
      </el-form-item>

      <el-form-item label="结束时间" prop="endTime">
        <el-date-picker clearable
                        v-model="queryParams.endTime"
                        type="date"
                        value-format="yyyy-MM-dd"
                        placeholder="结束时间">
        </el-date-picker>
      </el-form-item>
      <el-form-item label="审批类型" prop="serviceCatalog">
        <el-select v-model="queryParams.bpmnType" placeholder="审批类型" clearable>
          <el-option
            v-for="dict in dict.type.bus_bpmn_type"
            :key="dict.value"
            :label="dict.label"
            :value="dict.value"
          />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" icon="el-icon-search" size="mini" @click="handleQuery">搜索</el-button>
        <el-button icon="el-icon-refresh" size="mini" @click="resetQuery">重置</el-button>
      </el-form-item>
    </el-form>

    <el-row :gutter="10" class="mb8">
      <el-col :span="1.5">
        <el-button
          type="primary"
          plain
          icon="el-icon-plus"
          size="mini"
          @click="handleAdd"
        >流程定义部署</el-button
        >
      </el-col>

      <right-toolbar :showSearch.sync="showSearch" @queryTable="getList"></right-toolbar>
    </el-row>

    <el-table v-loading="loading" :data="bpmnInfoList" @selection-change="handleSelectionChange">

      <el-table-column label="流程(图)类型" align="center" prop="bpmnType" >
        <template slot-scope="scope">
          <dict-tag :options="dict.type.bus_bpmn_type" :value="scope.row.bpmnType"/>
        </template>
      </el-table-column>
      <el-table-column label="流程定义key" align="center" prop="processDefinitionKey" />
      <el-table-column label="版本号" align="center" prop="version"/>
      <el-table-column label="部署时间" align="center" prop="deployTime" width="180">
        <template slot-scope="scope">
          <span>{{ parseTime(scope.row.deployTime, '{y}-{m}-{d}') }}</span>
        </template>
      </el-table-column>
      <el-table-column label="描述信息" align="center" prop="info" />
      <el-table-column
        label="流程文件"
        align="center"
        class-name="small-padding fixed-width"
      >
        <template slot-scope="scope">
          <el-button
            size="medium"
            type="text"
            icon="el-icon-search"
            @click="handleReadResource(scope.row.id)"
            v-hasPermi="['business:bpmnInfo:readResource']"
          >查看</el-button
          >
        </template>
      </el-table-column>
      <el-table-column
        label="流程图"
        align="center"
        class-name="small-padding fixed-width"
      >
        <template slot-scope="scope">
          <el-button
            size="medium"
            type="text"
            icon="el-icon-search"
            @click="handleReadResourceImg(scope.row.id)"
            v-hasPermi="['business:bpmnInfo:readResource']"
          >查看</el-button
          >
        </template>
      </el-table-column>
      <el-table-column
        label="操作"
        align="center"
        class-name="small-padding fixed-width"
      >
        <template slot-scope="scope">
          <el-button
            size="mini"
            type="text"
            icon="el-icon-delete"
            @click="handleDelete(scope.row.id)"
            v-hasPermi="['flowdefinition:info:edit']"
          >撤销</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    
    <pagination
      v-show="total>0"
      :total="total"
      :page.sync="queryParams.pageNum"
      :limit.sync="queryParams.pageSize"
      @pagination="getList"
    />
    <el-dialog
      title="流程部署"
      :visible.sync="open"
      width="500px"
      append-to-body
    >
      <el-form ref="form" :model="form" label-width="100px" :rules="rules">
        <el-form-item label="审核类型" prop="bpmnType">
          <el-select
            v-model="form.bpmnType"
            placeholder="所有"
            style="width: 240px"
          >
            <el-option
              v-for="dict in dict.type.bus_bpmn_type"
              :key="dict.value"
              :label="dict.label"
              :value="dict.value"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="请选择文件: ">
          <el-upload
            ref="upfile"
            action="upload"
            style="display: inline"
            :auto-upload="false"
            :on-change="handleChange"
            :file-list="fileList"
          >
            <el-button type="success">选择文件</el-button>
          </el-upload>
        </el-form-item>

        <el-form-item label="备注" prop="info">
          <el-input
            v-model="form.info"
            type="textarea"
            placeholder="请输入内容"
          />
        </el-form-item>

        <el-form-item>
          <el-button type="primary" @click="submitForm">确 定</el-button>
          <el-button @click="cancel">取消</el-button>
        </el-form-item>
      </el-form>
    </el-dialog>

    <!-- 流程文件显示框 -->
    <el-dialog title="流程文件" :visible.sync="openResource" width="1200px">
      <div>{{ resource}}</div>
    </el-dialog>
    <!-- 流程图片显示框 -->
    <el-dialog title="流程图片" :visible.sync="openResourceImg" width="1200px">
      <div v-html="resourceImg"></div>
    </el-dialog>

  </div>

</template>

<script>
import {getBpmnInfoFile, deployBpmnInfo,listBpmnInfo, getBpmnInfo, delBpmnInfo, addBpmnInfo, updateBpmnInfo } from "@/api/business/bpmnInfo";

export default {
  name: "BpmnInfo",
  dicts: ['bus_bpmn_type'],
  data() {
    return {
      // 遮罩层
      loading: true,
      // 选中数组
      ids: [],
      // 非单个禁用
      single: true,
      // 非多个禁用
      multiple: true,
      // 显示搜索条件
      showSearch: true,
      // 总条数
      total: 0,
      fileList: [], //文件上传数组
      // 审核流程定义表格数据
      bpmnInfoList: [],
      // 弹出层标题
      title: "",
      // 是否显示弹出层
      open: false,
      // 查询参数
      queryParams: {
        pageNum: 1,
        pageSize: 10,
        startTime: null,
        endTime: null,
        bpmnType: null
      },
      // 表单参数
      form: {},
      // 表单校验
      rules: {
      },
      // 流程文件对象
      resource: '',
      // 流程文件弹窗显示隐藏
      openResource: false,
      // 流程图片弹窗显示隐藏
      openResourceImg: false,
      // 流程图片对象
      resourceImg:''
    };
  },
  created() {
    this.getList();
  },

  methods: {
    /** 查询审核流程定义列表 */
    getList() {
      this.loading = true;
      listBpmnInfo(this.queryParams).then(response => {
        this.bpmnInfoList = response.rows;
        this.total = response.total;
        this.loading = false;
      });
    },
    handleChange(file, fileList){
      this.fileList=fileList;
    },
    handleAdd() {
      this.reset();
      this.open = true;
      this.title = "流程部署";
    },
    // 取消按钮
    cancel() {
      this.open = false;
      this.reset();
    },
    // 表单重置
    reset() {
      this.form = {
        id: null,
        bpmnName: null,
        bpmnType: null,
        deploymentId: null,
        actProcessId: null,
        actProcessKey: null,
        deployTime: null,
        info: null
      };
      this.fileList=[];
      this.resetForm("form");
    },
    /** 搜索按钮操作 */
    handleQuery() {
      this.queryParams.pageNum = 1;
      this.getList();
    },
    /** 重置按钮操作 */
    resetQuery() {
      this.resetForm("queryForm");
      this.handleQuery();
    },
    // 多选框选中数据
    handleSelectionChange(selection) {
      this.ids = selection.map(item => item.id)
      this.single = selection.length!==1
      this.multiple = !selection.length
    },
    /** 新增按钮操作 */
    handleAdd() {
      this.reset();
      this.open = true;
      this.title = "添加审核流程定义";
    },
    /** 修改按钮操作 */
    handleUpdate(row) {
      this.reset();
      const id = row.id || this.ids
      getBpmnInfo(id).then(response => {
        this.form = response.data;
        this.open = true;
        this.title = "修改审核流程定义";
      });
    },
    /** 提交按钮 */
    submitForm() {
      this.$refs["form"].validate((valid) => {
        if (valid) {
          //拼接表单数据
          let formData=new FormData();
          formData.append("file",this.fileList[0].raw);
          formData.append("bpmnLabel",this.fileList[0].name);
          formData.append("bpmnType",this.form.bpmnType);
          formData.append("info",this.form.info);
          deployBpmnInfo(formData).then((res)=>{
            this.getList();
            this.open=false;
            this.$modal.msgSuccess(res.msg);
          }).catch((err)=>{
            this.open=false;
          });
        }
      });
    },
    /** 删除按钮操作 */
    handleDelete(id) {

      this.$modal.confirm('确定要撤销吗').then(function() {
        return delBpmnInfo(id);
      }).then(() => {
        this.getList();
        this.$modal.msgSuccess("撤销");
      }).catch(() => {});
    },
    /** 导出按钮操作 */
    handleExport() {
      this.download('business/bpmnInfo/export', {
        ...this.queryParams
      }, `bpmnInfo_${new Date().getTime()}.xlsx`)
    },
    handleReadResource(id){
      getBpmnInfoFile({id,type:"xml"}).then((res)=>{
        this.openResource=true;
        this.resource=res;
      });
    },
    handleReadResourceImg(id){
      getBpmnInfoFile({id,type:"png"}).then((res)=>{
        this.openResourceImg = true;
        this.resourceImg = res;
      })
    }
  },

};
</script>
```

bpmnInfo.js文件

```js
export function getBpmnInfoFile(params){
  return request({
    url:`/business/bpmnInfo/${params.type}/${params.id}`,
    method:'get'
  })
}

// 修改审核流程定义
export function updateBpmnInfo(data) {
  return request({
    url: '/business/bpmnInfo',
    method: 'put',
    data: data
  })
}

// 删除审核流程定义
export function delBpmnInfo(id) {
  return request({
    url: '/business/bpmnInfo/' + id,
    method: 'delete'
  })
}
```

3.5.7、流程文件查看

需求

#### 3.5.6.3、处理后端

实现思路：

- 参数校验
- 判断文件格式
- 把文件部署到 activiti 中
- 把信息保存到bpmninfo对象中

代码：

controller:

```java
@PreAuthorize("@ss.hasPermi('business:bpmnInfo:add')")
@Log(title = "审核流程定义", businessType = BusinessType.INSERT)
@PostMapping
public AjaxResult add(MultipartFile file,String bpmnLabel,Integer bpmnType,String info) throws IOException {
    busBpmnInfoService.deploy(file,bpmnLabel,bpmnType,info);
    return AjaxResult.success();
}
```

service：

```java
@Override
@Transactional
public void deploy(MultipartFile file, String bpmnLabel, Integer bpmnType, String info) throws IOException {

    //参数校验
    if(file == null){
        throw new RuntimeException("上传文件不能为空");
    }
    if(StringUtils.isEmpty(bpmnLabel) ||
            StringUtils.isEmpty(bpmnType+"") ||
            StringUtils.isEmpty(info)){
        throw new RuntimeException("非法参数");
    }
    //校验文件格式是否为 bpmn 格式文件
    String ext = FileUploadUtils.getExtension(file);
    if(!"bpmn".equals(ext)){
        throw new RuntimeException("文件格式必须为 bpmn 格式");
    }
    //把 bpmn 文件部署到 actviti 中
    Deployment deploy = repositoryService.
            createDeployment().
            addInputStream(bpmnLabel, file.getInputStream()).
            deploy();

    //查询流程定义
    ProcessDefinition processDefinition = repositoryService.
            createProcessDefinitionQuery().
            deploymentId(deploy.getId()).singleResult();
    //把 bpmnInfo 信息保存到数据库中
    BusBpmnInfo busBpmnInfo = new BusBpmnInfo();
    busBpmnInfo.setBpmnLabel(bpmnLabel);
    busBpmnInfo.setBpmnType(bpmnType);
    busBpmnInfo.setDeployTime(new Date());
    busBpmnInfo.setInfo(info);
    busBpmnInfo.setProcessDefinitionKey(processDefinition.getKey());
    busBpmnInfo.setVersion(Long.parseLong(processDefinition.getVersion()+""));
    busBpmnInfoMapper.insertBusBpmnInfo(busBpmnInfo);
}
```

### 3.5.7、流程文件查看

需求：当部署完以后，用户想要查看整理审批的步骤，可以点击流程文件查看，这里分为查看 xml 文件和查看 png 文件

#### 3.5.7.1、界面效果

Xml:

![image-20221130143517936](/Users/fanjialong/Documents/备课视频/最新项目课件整理/11-carO2O/讲义/image-20221130143517936.png)

png:

![image-20211012215439045](images/image-20211012215439045.png)

#### 3.5.7.2、处理后端

实现思路：

- 参数校验
- 根据 bpmninfo-id查询数据
- 查询流程定义信息
- 判断是 xml 还是 png
- 如果是 xml 响应xml
- 如果是 png 用工具类绘图

代码

```java
@Override
public InputStream getBpmn(String type, Long id) {
    //参数校验
    if(StringUtils.isEmpty(type) || StringUtils.isEmpty(id+"")){
        throw new  RuntimeException("非法操作");
    }
    BusBpmnInfo busBpmnInfo = busBpmnInfoMapper.selectBusBpmnInfoById(id);
    if(busBpmnInfo == null){
        throw new RuntimeException("非法操作");
    }
    InputStream inputStream = null;
    //判断类型是 xml 还是 png,如果是 xml 响应 xml 如果是图片响应图片
    //查询流程定义信息
    ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().
            processDefinitionKey(busBpmnInfo.getProcessDefinitionKey()).
            processDefinitionVersion(busBpmnInfo.getVersion().intValue()).singleResult();
    if("xml".equals(type)){
        inputStream = repositoryService.getResourceAsStream(processDefinition.getDeploymentId(), processDefinition.getResourceName());

    }else if("png".equals(type)){
        DefaultProcessDiagramGenerator processDiagramGenerator = new DefaultProcessDiagramGenerator();
        BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinition.getId());
        /**
         * 第一个参数: 流程定义模型
         * 第二个参数: 高亮节点集合
         * 第三个参数: 高亮连线集合
         */
        inputStream = processDiagramGenerator.generateDiagram(bpmnModel,
                Collections.emptyList(),
                Collections.emptyList(),
                "宋体",
                "宋体",
                "宋体");

    }else{
        throw new RuntimeException("非法操作");
    }
    return inputStream;
}
```

### 3.5.8、流程定义删除

需求：当点击删除，需要把 activiti 中流程定义删除掉，同时也要把 bpmnInfo 信息删除掉

实现思路：

- 参数校验
- 根据 bpmnInfo-id查询数据
- 查询流程定义
- 删除流程定义信息

代码：

```java
@Override
public void bpmnCancel(Long id) {
    if(StringUtils.isEmpty(id+"")){
        throw new RuntimeException("非法操作");
    }
    //删除 bpmnInfo 信息
    BusBpmnInfo busBpmnInfo = busBpmnInfoMapper.selectBusBpmnInfoById(id);
    ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionKey(busBpmnInfo.getProcessDefinitionKey()).
            processDefinitionVersion(busBpmnInfo.getVersion().intValue()).singleResult();
    /**.
     * TODO: 要查看这个流程定义下是否有流程实例,如果有需要找到流程实例
     * 根据流程实例找到 businessKey , 然后在把数据修改成初始化状态
     */
    busBpmnInfoMapper.deleteBusBpmnInfoById(id);

    //删除流程定义信息
    repositoryService.deleteDeployment(processDefinition.getDeploymentId(),true);
}
```

## 3.6：套餐审核

### 3.6.1、功能描述

上面也说了，可以消费结算单项里面有普通项，有套餐，普通单项不需要审核。因为套餐有优惠折扣跟最终定价，这就要求必须经过店长拍板才行，所以需要引入审核流程。

需求要求：

1、如果套餐最终定价店长不同意，审核流程结束，审核失败

2、如果套餐最终定价店长同意，且套餐优惠价小于3000，直接流程结束，审核通过

3、如果套餐最终定价店长同意，且套餐优惠价大于等于3000，需要财务审核，

​		如果财务同意则流程结束，审核通过，

​		如果财务部不同意则流程结束，审核失败

bpmn

![image-20211012105835099](images/image-20211012105835099.png)

原型：

![image-20221129120016793](images/image-20221129120016793.png)

### 3.6.2、具体需求

1、服务套餐发起审核

2、套餐审核列表

3、查看审核进度

4、套餐审核撤销

### **3.6.3、表设计**

思考：套餐审核表应该怎么设计？

bus_car_package_audit

![image-20221129120406377](images/image-20221129120406377.png)

需要注意字段：status、流程实例 id

### 3.6.4、套餐列表

准备工作：

- 先创建菜单
- 添加数据字典

#### 3.6.4.1、界面效果

![image-20221129120016793](images/image-20221129120016793.png)

#### 3.6.4.2、处理前端

高级查询部分：保留开始时间结束时间，审批转台

按钮部分： 全部删除掉

表格部分：把多余字段删除，处理备注，处理状态，处理按钮

#### 3.6.4.3、处理后端

设计表之后，根据代码生成器创建 domain、mapper、xml、service…..

```java
@Getter
@Setter
@ToString
public class BusCarPackageAudit extends BaseEntity
{
    private static final long serialVersionUID = 1L;
    public static final String STATUS_IN_ROGRESS = "0";//审核中
    public static final String STATUS_REJECT = "1";//审核拒绝
    public static final String STATUS_PASS = "2";//审核通过
    public static final String STATUS_CANCEL = "3";//审核撤销

    /** 主键 */
    private Long id;

    /** 服务单项id */
    @Excel(name = "服务单项id")
    private Long serviceItemId;

    /** $column.columnComment */
    private String serviceItemName;

    /** 服务单项备注 */
    @Excel(name = "服务单项备注")
    private String serviceItemInfo;

    /** 服务单项审核价格 */
    @Excel(name = "服务单项审核价格")
    private BigDecimal serviceItemPrice;

    /** 流程实例id */
    @Excel(name = "流程实例id")
    private String instanceId;

    /** 创建者 */
    @Excel(name = "创建者")
    private String creatorId;

    /** 备注 */
    @Excel(name = "备注")
    private String info;

    /** 状态【进行中0/审核拒绝1/审核通过2/审核撤销3】 */
    @Excel(name = "状态【进行中0/审核拒绝1/审核通过2/审核撤销3】")
    private String status;

}
```

### 3.6.5、发起审核

需求：服务单项界面中，如果是套餐需要审批通过以后才可以上架

#### 3.6.5.1、处理前端

添加按钮：

```html
<el-col :span="1.5">
  <el-button
    type="warning"
    plain
    icon="el-icon-download"
    size="mini"
    @click="handleAudit"
    :disabled="isNotAudit"
    v-hasPermi="['business:serviceitem:audit']"
    >发起审核</el-button
  >
</el-col>
```

table表格中加入复选框

```html
<el-table-column type="selection" width="55" align="center" />
```

加入模态框

```html
<el-dialog 
  title="审核页面"
  :visible.sync="auditOpen"
  width="600px"
  append-to-body
  >
  <el-form
    ref="auditInfo"
    :model="auditInfo"
    :rules="auditRules"
    label-width="150px"
  >
    <el-form-item label="服务单项名称：" prop="name">
      <el-input disabled v-model="auditInfo.serviceItem.name" />
    </el-form-item>
    <el-form-item label="原价：" prop="originalPrice">
      <el-input disabled v-model="auditInfo.serviceItem.originalPrice" />
    </el-form-item>
    <el-form-item label="折扣价：" prop="discountPrice">
      <el-input disabled v-model="auditInfo.serviceItem.discountPrice" />
    </el-form-item>
    <el-form-item label="审核人(店长)：" prop="shopOwners">
      <el-select
        size="medium"
        v-model="shopOwnerId"
      >
        <el-option
          v-for="(item) in auditInfo.shopOwners"
          :key="item.userId"
          :label="item.nickName"
          :value="item.userId"
        >
        </el-option>
      </el-select>
    </el-form-item>
    <el-form-item
      label="审核人(财务)："
      v-if="auditInfo.serviceItem.discountPrice >= auditInfo.discountPrice"
      prop="finances"
    >
      <el-select 
        size="medium"
        v-model="financeId"
        >
        <el-option
          v-for="(item) in auditInfo.finances"
          :key="item.userId"
          :label="item.nickName"
          :value="item.userId"
        >
        </el-option>
      </el-select>
    </el-form-item>
    <el-form-item label="备注信息：" prop="info">
      <el-input v-model="form.info" />
    </el-form-item>
  </el-form>
  <div slot="footer" class="dialog-footer">
    <el-button type="primary" @click="auditSubmit">确 定</el-button>
    <el-button @click="cancel">取 消</el-button>
  </div>
</el-dialog>
```

在 data 中加入需要属性

```js
// 是否可以发起审核
isNotAudit: true,
// 是否显示审核页面
auditOpen:false,
 auditInfo:{
        serviceItem: {},
        shopOwners: {},
        finances:{},
        discountPrice:0
      },
shopOwnerId:null,
financeId:null
```

method 中加入方法

```
 handleSelectionChange(selection) {
      // 可以发起编辑的状态
      // 处理单个发起审核的
      // 是套餐,未上架,初始化状态,审批被拒绝的
      // 是否套餐【是1/否0】
      // 【1已上架/0未上架】
      // 审核状态【初始化/审核中/审核通过/审核拒绝/无需审核】
      let isSingleSeletion=selection.length == 1;
      if(!isSingleSeletion){//非当个
        this.isNotAudit = true;
        return;
      }
      let serviceItem=selection[0];
      let isPacakge=serviceItem.carPackage == 1; // 是套餐
      let isNoOnSale=serviceItem.saleStatus == 0; // 未上架
      let isPassAudit=serviceItem.auditStatus == 0 || serviceItem.auditStatus == 3;
      if(!isPacakge){ //非套餐
        this.isNotAudit = true;
        return;
      }
      if(!isNoOnSale){//已上架
        this.isNotAudit = true;
        return;
      }
      if(!isPassAudit){//审核校验不通过
        this.isNotAudit = true;
        return;
      }
      this.isNotAudit = false;
      this.id= serviceItem.id;
    },
    
     /** 发起审核处理 */
    handleAudit() {
      if(this.isNotAudit){
        return;
      }
      this.auditOpen=true;
      this.reset();
      serviceItemAuditInfo({id:this.id}).then((response)=>{
        this.auditInfo=response.data;
        this.shopOwnerId=this.auditInfo.shopOwners[0].userId;
        if(this.auditInfo.finances !==undefined){
          this.financeId=this.auditInfo.finances[0].userId;
        }
      })
    },
     /** 审核提交 */
    auditSubmit() {
      this.auditOpen=false;
      let auditParams={
        id: this.auditInfo.serviceItem.id,
        shopOwnerId:this.shopOwnerId,
        financeId:this.financeId,
        info:this.form.info
      };
      serviceItemStartAudit(auditParams).then((response)=>{
        this.$modal.msgSuccess("提交成功");
        this.getList();
      });
    },
     // 取消按钮
    cancel() {
      this.auditOpen=false;
      this.open = false;
      this.reset();
    },
```

在 import中导入方法

```java
import {
  listItem,
  getItem,
  delItem,
  addItem,
  updateItem,
  serviceItemSaleOn,
  serviceItemSaleOff,
  serviceItemAuditInfo,
  serviceItemStartAudit
} from "@/api/business/serviceitem";
```

在 serviceItem.js中加入

```js
//发起审核按钮操作
export function serviceItemAuditInfo(params){
  return request({
    url: '/business/serviceitem/audit/' +params.id,
    method: 'get'
  });
}
//审核提交操作
export function serviceItemStartAudit(params) {
  return request({
    url: '/business/serviceitem/audit',
    method: 'put',
    data: params
  })
}
```

#### 3.6.5.2、处理后端

发起审核一共分两步，一是打开界面把界面要的数据给界面， 二是打开界面以后发起审核操作

准备工作：

1、先创建 2 个角色店长和财务，在角色管理中

![image-20221207114740518](images/image-20221207114740518.png)

2 、在系统创建两个用户xiaohei 和 xiaobai,小黑是店长，小白是财务

![image-20221207114515861](images/image-20221207114515861.png)

3、为了测试方便我们给他所有权限，给店长和财务所有权限，在角色管理设置

4、在参数管理中加入一个折扣价限制条件

![image-20221207114821937](images/image-20221207114821937.png)

审核界面思路：

- 先创建 vo 对象封装前台界面数据

- 根据 id 获取数据

- 判断是否是套餐

- 判断是否是初始化或者是重新调整状态

- 根据角色的 key 去数据库查询数据

- 在系统参数中加一个限制金额，进行查询

- 判断折扣价格是否大于我们设置的参数，如果大于了就把财务也设置进去

  如果没有大于就不设置

代码：

vo：

```java
@Data
public class ServiceItemAuditInfo {
    private BusServiceItem serviceItem;
    private List<SysUser> shopOwners;
    private List<SysUser> finances;
    private BigDecimal discountPrice;
}
```

业务层 ：

```java
  @Override
    public AuditServiceItemVO audit(Long id) {
        if(id == null){
            throw new RuntimeException("非法操作");
        }
        BusServiceItem busServiceItem = busServiceItemMapper.selectBusServiceItemById(id);
        if(busServiceItem == null){
            throw new RuntimeException("非法操作");
        }
        //判断是否是套餐
        if(!BusServiceItem.CARPACKAGE_YES.equals(busServiceItem.getCarPackage())){
            throw new RuntimeException("必须是套餐才可以审核");
        }
        //把数据封装到 vo 对象中
        AuditServiceItemVO vo = new AuditServiceItemVO();
        //判断是否处于初始化或者是重新调整
        if(BusServiceItem.AUDITSTATUS_INIT.equals(busServiceItem.getAuditStatus())||
                BusServiceItem.AUDITSTATUS_REPLY.equals(busServiceItem.getAuditStatus())){

            vo.setServiceItem(busServiceItem);
            //查询店长信息
            List<SysUser> shopOnwers = sysUserService.queryByRoleKey("shopOwner");
            vo.setShopOwners(shopOnwers);
            //设置折扣金额
            String obj = sysConfigService.selectConfigByKey(" discountPriceLimit");
            vo.setDiscountPrice(new BigDecimal(obj));

            if(busServiceItem.getDiscountPrice().compareTo(new BigDecimal(obj)) > 0){
                //查询财务信息
                List<SysUser> finances = sysUserService.queryByRoleKey("finance");
                vo.setFinances(finances);
            }

        }else{
            throw new RuntimeException("非法操作");
        }

        return vo;
    }
```

sql 语句

```sql
  <select id="queryByRoleKey" resultMap="SysUserResult">
   select u.* from sys_user u left join sys_user_role  ur  on (u.user_id = ur.user_id)
                        left JOIN sys_role  r   on (r.role_id = ur.role_id)
   where r.role_key = #{key}
</select>
```

发起审核思路

- 参数校验
- 根据 id 查询服务单项
- 判断是否是套餐
- 判断是否处于初始化和重新调整
- 查询 bpmninfo 信息
- 创建业务表把数据封装进去
- 设置流程变量
- 启动流程
- 更新 carPackageAudit 信息
- 更新服务单项状态为审批中状态

代码：

```java
@Override
@Transactional
public void startAudit(AuditVO vo) {
    //做参数校验
    if(vo == null){
        throw new RuntimeException("非法操作");
    }

    //根据 id 查询数据
    BusServiceItem busServiceItem = busServiceItemMapper.selectBusServiceItemById(vo.getId());
    if(busServiceItem == null){
        throw new RuntimeException("非法操作");
    }
    //判断是否是套餐
    if(!BusServiceItem.CARPACKAGE_YES.equals(busServiceItem.getCarPackage())){
        throw new RuntimeException("必须是套餐才可以审核");
    }

    //判断是否处于初始化或者是重新调整
    if(BusServiceItem.AUDITSTATUS_INIT.equals(busServiceItem.getAuditStatus())||
            BusServiceItem.AUDITSTATUS_REPLY.equals(busServiceItem.getAuditStatus())){
        // 查询 bpmnInfo 信息
        BusBpmnInfo busBpmnInfo = busBpmnInfoMapper.queryByType(BusCarPackageAudit.FLOW_AUDIT_TYPE);
        // 创建 CarPackageAudit 保存到业务表中
        BusCarPackageAudit carPackageAudit = new BusCarPackageAudit();
        carPackageAudit.setCreatorId(SecurityUtils.getUserId().toString());
        carPackageAudit.setInfo(vo.getInfo());
        carPackageAudit.setServiceItemId(busServiceItem.getId());
        carPackageAudit.setCreateTime(new Date());
        carPackageAudit.setServiceItemInfo(busServiceItem.getInfo());
        carPackageAudit.setServiceItemName(busServiceItem.getName());
        carPackageAudit.setServiceItemPrice(busServiceItem.getDiscountPrice());
        carPackageAudit.setStatus(BusCarPackageAudit.STATUS_IN_ROGRESS);
        carPackageAuditMapper.insertBusCarPackageAudit(carPackageAudit);
        // 设置流程变量
        Map<String,Object> map = new HashMap<>();
        map.put("shopOwnerId",vo.getShopOwnerId());
        if(vo.getFinanceId() !=null){
            map.put("financeId",vo.getFinanceId());
        }
        map.put("disCountPrice",busServiceItem.getDiscountPrice().longValue());
        // 启动流程实例
        ProcessInstance processInstance = runtimeService.
                startProcessInstanceByKey(busBpmnInfo.getProcessDefinitionKey(),
                        carPackageAudit.getId().toString(), map);

        carPackageAudit.setInstanceId(processInstance.getId());
        carPackageAuditMapper.updateBusCarPackageAudit(carPackageAudit);

        // 修改单项状态为审核中状态
        busServiceItemMapper.updateAuitStatus(vo.getId(),Integer.parseInt(BusServiceItem.AUDITSTATUS_AUDITING));

    }else{
        throw new RuntimeException("非法操作");
    }


}
```

### 3.5.6、进度查看

#### 3.5.6.1、界面效果

![image-20221207120058232](images/image-20221207120058232.png)

#### 3.5.6.2、处理前端

添加按钮

```html
<template slot-scope="scope">
  <el-button
    size="mini"
    type="text"
    icon="el-icon-edit"
    @click="listHistory(scope.row.instanceId)"
  >审批历史</el-button
  >
  <el-button
    size="mini"
    type="text"
    icon="el-icon-info"
    @click="viewProcess(scope.row.id)"
  >进度查看</el-button
  >
  <el-button
    size="mini"
    type="text"
    icon="el-icon-delete"
    @click="cancelAudit(scope.row.id)"
  >撤销</el-button
  >
```

添加模态框

```html
<el-dialog
  title="审批历史"
  :visible.sync="historyDialog.open"
  width="1200px"
  append-to-body
>
  <el-table
    ref="tables"
    v-loading="historyDialog.loading"
    :data="historyDialog.list"
  >
    <el-table-column label="任务名称" align="center" prop="taskName"  width="180"/>
    <el-table-column label="开始时间" align="center" prop="startTime" />
    <el-table-column
      label="结束时间"
      align="center"
      prop="endTime"
      width="180"
      :show-overflow-tooltip="true"
    />
    <el-table-column
      label="耗时"
      align="center"
      prop="durationInMillis"
      width="180"
    >
    </el-table-column>
    <el-table-column
      label="审批意见"
      align="center"
      prop="comment"
      width="180"
    >
    </el-table-column>
  </el-table>
  <div slot="footer" class="dialog-footer">
    <el-button @click="closeHistoryDialog">关 闭</el-button>
  </div>
</el-dialog>

<el-dialog
  title="流程进度图"
  :visible.sync="processDialog.open"
  width="1200px"
  append-to-body
>
  <div v-html="processDialog.img"></div>
  <div slot="footer" class="dialog-footer">
    <el-button @click="closeProcessDialog">关 闭</el-button>
  </div>
</el-dialog>
```

添加 data

```js
// 审批历史弹窗
historyDialog: {
  open: false, // 显示状态
  loading: false, // 加载状态
  list: [], // 列表数据
},
// 流程进度图弹窗
processDialog: {
  open: false,
  img: '',
}
```

添加方法

```js
listHistory(instanceId){
  this.historyDialog.open = true
  this.historyDialog.loading = true
  // 请求审批历史接口的方法
  carPackageAuditHistory(instanceId).then((res) => {
    this.historyDialog.list = res.rows;
    this.historyDialog.loading = false;
  });
},
// 关闭审批历史弹窗
closeHistoryDialog() {
  this.historyDialog.open = false;
},

// 查看进度
viewProcess(id) {
  this.processDialog.open = true;
  carPackageAuditProcess(id).then((res) => {
    this.processDialog.img = res;
  });
},
// 关闭流程进度图弹窗
closeProcessDialog() {
  this.processDialog.open = false
},
// 撤销审批
cancelAudit(id) {
  this.$confirm("此操作将撤销审核, 是否继续?", "提示", {
    confirmButtonText: "确定",
    cancelButtonText: "取消",
    type: "warning",
  }).then(() => {
    cancelCarPackageAudit(id).then((res) => {
      this.getList();
      this.$modal.msgSuccess("撤销成功");
    }).catch(() => {
    });
  })
},
```

在 import 中引入

```js
import { listTodo,carPackageAudit,carPackageAuditHistory,carPackageAuditProcess,cancelCarPackageAudit } from "@/api/business/audit";
```

audit.js

```

// 我的待办
export function listTodo(params){
  return request({
    url: '/business/carPackageAuit/todo',
    method: 'get',
    params
  })
}

// 审核
export function carPackageAudit(data){
  return request({
    url: '/business/carPackageAuit/audit',
    method: 'post',
    data
  })
}

// 审批历史
export function carPackageAuditHistory(instanceId) {
  return request({
    url: '/business/carPackageAuit/history/' + instanceId,
    method: 'get',
  })
}

// 查看进度
export function carPackageAuditProcess(id) {
  return request({
    url: '/business/carPackageAuit/process/' + id,
    method: 'get',
  })
}

// 我的已办
export function listDone(params) {
  return request({
    url: '/business/carPackageAuit/done',
    method: 'get',
    params
  })
}
// 撤销套餐审核
export function cancelCarPackageAudit(id){
  return request({
    url: '/business/carPackageAuit/cancel/'+id,
    method: 'put'
  })
}

```

#### 3.5.6.3、处理后端

需求：让流程当前走到的节点高亮，响应流程图

思路：

- 参数校验
- 根据 id 查询 carPackage数据
- 根据类型查询 bpmnInfo 信息
- 查询流程定义
- 判断 carPackageAudit 是否是审核中
- 如果是 获取当前高亮节点集合，如果不是空集合
- 调用工具类绘图

代码：

```java
@Override
public InputStream process(Long id) {
    //参数校验
    if(id == null){
        throw new RuntimeException("非法操作");
    }
    //根据 id 查询数据
    BusCarPackageAudit carPackageAudit = busCarPackageAuditMapper.selectBusCarPackageAuditById(id);
    if(carPackageAudit == null){
        throw new RuntimeException("非法操作");
    }

    BusBpmnInfo busBpmnInfo = busBpmnInfoMapper.queryByType(BusCarPackageAudit.FLOW_AUDIT_TYPE);
    ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().
            processDefinitionKey(busBpmnInfo.getProcessDefinitionKey()).
            processDefinitionVersion(Integer.parseInt(busBpmnInfo.getVersion() + "")).singleResult();


    List<String> activeActivityIds = new ArrayList<>();
    if(carPackageAudit.getStatus().equals(BusCarPackageAudit.STATUS_IN_ROGRESS)){
         activeActivityIds = runtimeService.getActiveActivityIds(carPackageAudit.getInstanceId());
    }else{
        activeActivityIds = Collections.emptyList();
    }


    DefaultProcessDiagramGenerator processDiagramGenerator = new DefaultProcessDiagramGenerator();
    BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinition.getId());


    /**
     * 第一个参数: 流程定义模型
     * 第二个参数: 高亮节点集合
     * 第三个参数: 高亮连线集合
     */
    InputStream inputStream = processDiagramGenerator.generateDiagram(bpmnModel,
            activeActivityIds,
            Collections.emptyList(),
            "宋体",
            "宋体",
            "宋体");
    return inputStream;
}
```

### 3.6.7、撤销流程

需求：申请人不想申请了，可以进行撤销，需要把业务表状态改成撤销状态，服务单项表修改为初始化状态

#### 3.6.7.1、界面效果

![image-20221207121727626](images/image-20221207121727626.png)

#### 3.6.7.2、处理前端

在前面已经处理过了这里不做处理

#### 3.6.7.3、处理后端

实现思路：

- 参数校验
- 根据 id 查询业务表数据
- 判断是否为审核中状态
- 修改 carPackageAudit 状态为撤销状态
- 修改服务单项状态为初始化状态
- 删除流程实例

代码：

```java
@Override
public void cancel(Long id) {
    //参数校验
    if(id == null){
        throw new RuntimeException("非法操作");
    }

    //根据 id 查询数据
    BusCarPackageAudit carPackageAudit = busCarPackageAuditMapper.selectBusCarPackageAuditById(id);
    if(!BusCarPackageAudit.STATUS_IN_ROGRESS.equals(carPackageAudit.getStatus())){
        throw new RuntimeException("非法操作");
    }

    //修改 carPackageAudit 状态
    busCarPackageAuditMapper.updateStatus(id,BusCarPackageAudit.STATUS_CANCEL);
    //修改 item 转台
    itemMapper.updateAuitStatus(carPackageAudit.getServiceItemId(),Integer.parseInt(BusServiceItem.AUDITSTATUS_INIT));
    //删除流程实例
    runtimeService.deleteProcessInstance(carPackageAudit.getInstanceId(),"123");
}
```

## 3.7、我得代办

### 3.7.1、功能描述

我的待办，也就是我的待办任务，即某个流程点负责人准备要审核的哪些流程。

原型：

![image-20221207122412680](images/image-20221207122412680.png)

### 3.7.2、具体需求

1、我的待办列表

2、审批实现

3、审批历史

4、进度查看(和上面一样)

5、撤销(和上面一样)

### 3.7.3、表设计

表查询的还是 carPackageAudit 得信息

### 3.7.4、待办列表

#### 3.7.4.1、界面效果

![image-20221207122652337](images/image-20221207122652337.png)

#### 3.7.4.2、前端处理

准备工作：添加按钮

![image-20221207122802208](images/image-20221207122802208.png)

在 business/carPackageAudit/创建一个 todo 目录，把 index.vue拷贝进去

index.vue

```vue
<template>
  <div class="app-container">
    <!-- 表格 -->
    <el-table v-loading="loading" :data="auditList">
      <el-table-column label="套餐名称" align="center" prop="serviceItemName" />
      <el-table-column
        label="套餐价格"
        align="center"
        prop="serviceItemPrice"
      />
      <el-table-column
        label="套餐备注"
        align="center"
        prop="serviceItemInfo"
        :show-overflow-tooltip="true"
      />
      <el-table-column
        label="创建时间"
        align="center"
        prop="createTime"
        width="180"
      ></el-table-column>
      <el-table-column label="状态" align="center" prop="status">
        <template slot-scope="scope">
          <dict-tag
            :options="dict.type.bus_car_audit_status"
            :value="scope.row.status"
          ></dict-tag>
        </template>
      </el-table-column>

      <el-table-column
        label="操作"
        align="center"
        class-name="small-padding fixed-width"
      >
        <template slot-scope="scope">
          <el-button
            size="mini"
            type="text"
            icon="el-icon-edit"
            @click="handleAudit(scope.row.id)"
            >审批</el-button
          >
          <el-button
            size="mini"
            type="text"
            icon="el-icon-edit"
            @click="listHistory(scope.row.instanceId)"
            >审批历史</el-button
          >
          <el-button
            size="mini"
            type="text"
            icon="el-icon-info"
            @click="viewProcess(scope.row.id)"
            >进度查看</el-button
          >
        </template>
      </el-table-column>
    </el-table>

    <pagination
      v-show="total > 0"
      :total="total"
      :page.sync="queryParams.pageNum"
      :limit.sync="queryParams.pageSize"
      @pagination="getList"
    />

    <!--  审核对话框  -->
    <el-dialog
      title="流程审核"
      :visible.sync="auditDialog.open"
      width="500px"
      append-to-body
    >
      <el-form
        ref="auditForm"
        :model="auditDialog.data"
        label-width="80px"
      >
        <el-col :span="12">
          <el-form-item label="审批意见" prop="auditStatus">
            <el-select
              v-model="auditDialog.data.auditStatus"
              placeholder="请选择审批意见"
            >
              <el-option value="true" label="同意"></el-option>
              <el-option value="false" label="拒绝"></el-option>
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="24">
          <el-form-item label="批注" prop="info">
            <el-input
              v-model="auditDialog.data.info"
              type="textarea"
              placeholder="请输入批注"
              maxlength="250"
              rows="4"
            ></el-input>
          </el-form-item>
        </el-col>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="primary" @click="submitAuditForm">确 定</el-button>
        <el-button @click="cancel">取 消</el-button>
      </div>
    </el-dialog>
    <!-- 审批历史  -->
    <el-dialog title="审批历史" :visible.sync="historyDialog.open" width="1200px" append-to-body>
      <el-table ref="tables" v-loading="historyDialog.loading" :data="historyDialog.list" :default-sort="defaultSort">
        <el-table-column label="任务名称" align="center" prop="taskName"/>
        <el-table-column label="开始时间" align="center" prop="startTime" width="180"/>
        <el-table-column label="结束时间" align="center" prop="endTime" width="180" :show-overflow-tooltip="true"/>
        <el-table-column label="耗时" align="center" prop="durationInMillis" width="180"/>
        <el-table-column label="审批意见" align="center" prop="comment" width="180"/>
      </el-table>
      <div slot="footer" class="dialog-footer">
        <el-button @click="cancel">关 闭</el-button>
      </div>
    </el-dialog>
     <!--  流程进度图对话框  -->
     <el-dialog title="流程进度图" :visible.sync="processDialog.open" width="1200px" append-to-body>
      <div v-html="processDialog.img"></div>
      <div slot="footer" class="dialog-footer">
        <el-button @click="cancel">关 闭</el-button>
      </div>
    </el-dialog>
  </div>
</template>
    
<script>
import { listTodo,carPackageAudit,carPackageAuditHistory,carPackageAuditProcess } from "@/api/business/audit";

export default {
  name: "Audit",
  dicts: ["bus_car_audit_status"],
  data() {
    return {
      // 遮罩层
      loading: true,
      // 选中数组
      ids: [],
      // 非单个禁用
      single: true,
      // 非多个禁用
      multiple: true,
      // 显示搜索条件
      showSearch: true,
      // 总条数
      total: 0,
      // 套餐审核表格数据
      auditList: [],
      dateRange: [],
      // 弹出层标题
      title: "",
      // 是否显示弹出层
      open: false,
        // 默认排序
      defaultSort: {prop: "loginTime", order: "descending"},
      // 查询参数
      queryParams: {
        pageNum: 1,
        pageSize: 10,
        serviceItemId: null,
        serviceItemName: null,
        serviceItemInfo: null,
        serviceItemPrice: null,
        instanceId: null,
        creatorId: null,
        info: null,
        status: null,
      },
      // 表单参数
      form: {},
      // 表单校验
      rules: {},
      auditDialog: {
        open: false,
        data: {},
        rules: {
          auditStatus: [
            { required: true, message: "审批意见不能为空", trigger: "blur" },
          ],
          info: [
            { required: true, message: "批注信息不能为空", trigger: "blur" },
          ],
        },
      },
      // 审批历史弹窗
      historyDialog: {
        open: false,
        loading: false,
        list: [],
      },
      // 流程进度图弹窗
      processDialog: {
        open: false,
        img: '',
      },
    };
  },
  created() {
    this.getList();
  },
  methods: {
    /** 查询套餐审核列表 */
    getList() {
      this.loading = true;
      listTodo(this.queryParams).then((response) => {
        this.auditList = response.rows;
        this.total = response.total;
        this.loading = false;
      });
    },
    // 取消按钮
    cancel() {
      this.historyDialog.open= false;
      this.auditDialog.open= false;
      this.processDialog.open= false;
      this.open = false;
      this.reset();
    },
    // 表单重置
    reset() {
      this.form = {
        id: null,
        serviceItemId: null,
        serviceItemName: null,
        serviceItemInfo: null,
        serviceItemPrice: null,
        instanceId: null,
        creatorId: null,
        info: null,
        status: 0,
        createTime: null,
      };
      this.resetForm("form");
    },
    /** 搜索按钮操作 */
    handleQuery() {
      this.queryParams.pageNum = 1;
      this.getList();
    },
    /** 重置按钮操作 */
    resetQuery() {
      this.resetForm("queryForm");
      this.handleQuery();
    },
    // 多选框选中数据
    handleSelectionChange(selection) {
      this.ids = selection.map((item) => item.id);
      this.single = selection.length !== 1;
      this.multiple = !selection.length;
    },
    /** 新增按钮操作 */
    handleAdd() {
      this.reset();
      this.open = true;
      this.title = "添加套餐审核";
    },
    /** 修改按钮操作 */
    handleUpdate(row) {
      this.reset();
      const id = row.id || this.ids;
      getAudit(id).then((response) => {
        this.form = response.data;
        this.open = true;
        this.title = "修改套餐审核";
      });
    },
    /** 提交审核 */
    submitAuditForm() {
        this.$refs['auditForm'].validate(valid =>{
            if(!valid) return;
            carPackageAudit(this.auditDialog.data).then(res=>{
                this.auditDialog.open = false;
                this.getList();
                this.$modal.msgSuccess("审批成功");
            }).catch(() => {});;
        });
    },
    /** 删除按钮操作 */
    handleDelete(row) {
      const ids = row.id || this.ids;
      this.$modal
        .confirm('是否确认删除套餐审核编号为"' + ids + '"的数据项？')
        .then(function () {
          return delAudit(ids);
        })
        .then(() => {
          this.getList();
          this.$modal.msgSuccess("删除成功");
        })
        .catch(() => {});
    },
    handleAudit(id) {
        this.resetForm("auditForm");
        this.auditDialog.data={};
        this.auditDialog.open=true;
        this.auditDialog.data.id= id;
    },
    listHistory(instanceId){
      this.historyDialog.open = true
      this.historyDialog.loading = true
      // 请求审批历史接口的方法
      carPackageAuditHistory(instanceId).then((res) => {
        this.historyDialog.list = res.rows;
        this.historyDialog.loading = false;
      });
    },
    // 查看进度
    viewProcess(id) {
      this.processDialog.open = true;
      carPackageAuditProcess(id).then((res) => {
        this.processDialog.img = res;
      });
    },
  },
};
</script>
```

#### 3.7.4.3、处理后端

实现思路：

- 根据类型查询 bpmnInfo 信息
- 根据用户 id 和流程定义 key 查询待办任务结合
- 如果不为空，遍历获取流程
- 根据流程实例获取 businessKey(业务表 id) 结合
- 根据集合查询数据

代码：

```java
 // 先查询 bpmninfo 信息
        BusBpmnInfo busBpmnInfo = busBpmnInfoMapper.queryByType(BusCarPackageAudit.FLOW_AUDIT_TYPE);
        if(busBpmnInfo == null){
            throw new RuntimeException("非法操作");
        }
        //查询待办任务
        List<Task> list = taskService.createTaskQuery().
                taskAssignee(SecurityUtils.getUserId().toString()).
                processDefinitionKey(busBpmnInfo.getProcessDefinitionKey()).list();

        if(list == null || list.size() == 0){
            return null;
        }
        //根据任务查询流程实例 id集合
        List<String> keys = new ArrayList<>();
        for (Task task : list) {
            ProcessInstance processInstance = runtimeService.
                    createProcessInstanceQuery().
                    processInstanceId(task.getProcessInstanceId()).singleResult();
            String businessKey = processInstance.getBusinessKey();
            keys.add(businessKey);
        }
        //根据流程实例 id 查询,businesskey 结合
        PageUtils.startPage();
        //根据 userId 去查询
        List<BusCarPackageAudit> carPackageAudits = busCarPackageAuditMapper.queryBusinessKeys(keys);
        return carPackageAudits;
```

Mapper.xml

```
<select id="queryBusinessKeys" resultMap="BusCarPackageAuditResult">
    select * from bus_car_package_audit
    where id in
    <foreach collection="keys" open="(" separator="," item="id" close=")">
        #{id}
    </foreach>
</select>
```

### 3.7.5、审批

需求: 申请人发起审批以后，审批人可以在我得代办列表中处理需要处理的任务

#### 3.7.5.1、界面效果

![image-20221207124040574](images/image-20221207124040574.png)

#### 3.7.5.2、处理前端

加入模态框

```java
<el-dialog
  title="流程审核"
  :visible.sync="auditDialog.open"
  width="500px"
  append-to-body
>
  <el-form
    ref="auditForm"
    :model="auditDialog.data"
    label-width="80px"
  >
    <el-col :span="12">
      <el-form-item label="审批意见" prop="auditStatus">
        <el-select
          v-model="auditDialog.data.auditStatus"
          placeholder="请选择审批意见"
        >
          <el-option value="true" label="同意"></el-option>
          <el-option value="false" label="拒绝"></el-option>
        </el-select>
      </el-form-item>
    </el-col>
    <el-col :span="24">
      <el-form-item label="批注" prop="info">
        <el-input
          v-model="auditDialog.data.info"
          type="textarea"
          placeholder="请输入批注"
          maxlength="250"
          rows="4"
        ></el-input>
      </el-form-item>
    </el-col>
  </el-form>
  <div slot="footer" class="dialog-footer">
    <el-button type="primary" @click="submitAuditForm">确 定</el-button>
    <el-button @click="cancel">取 消</el-button>
  </div>
</el-dialog>
```

加入处理方法

```java
submitAuditForm() {
    this.$refs['auditForm'].validate(valid =>{
        if(!valid) return;
        carPackageAudit(this.auditDialog.data).then(res=>{
            this.auditDialog.open = false;
            this.getList();
            this.$modal.msgSuccess("审批成功");
        }).catch(() => {});;
    });
},
```

在 js 中加入发送请求代码

```js
export function carPackageAudit(data){
  return request({
    url: '/business/carPackageAuit/audit',
    method: 'post',
    data
  })
}
```

在 data 加入模态框需要的数据

```js
auditDialog: {
  open: false,
  data: {},
  rules: {
    auditStatus: [
      { required: true, message: "审批意见不能为空", trigger: "blur" },
    ],
    info: [
      { required: true, message: "批注信息不能为空", trigger: "blur" },
    ],
  },
},
```

#### 3.7.5.3、处理后端

实现思路：

- 参数校验
- 根据 id 查询 carPackageAudit
- 判断是否为空
- 判断是否为审批中
- 获取到当前任务节点
- 添加批注
- 设置流程变量
- 完成任务
- 判断是同意还是拒绝
- 如果是拒绝修改 carPackageAudit状态和单项状态
- 如果同意，判断是否有下一个节点
- 如果没有下一个节点，设置状态为同意状态



代码：

```java
 @Override
    @Transactional
    public void audit(CarPackageAuditVO vo) {
        //参数校验
        if(vo == null){
            throw new RuntimeException("非法操作");
        }
        //根据 id 查询 carPackgeAudit
        BusCarPackageAudit carPackageAudit = busCarPackageAuditMapper.selectBusCarPackageAuditById(vo.getId());
        if(carPackageAudit == null){
            throw new RuntimeException("非法操作");
        }
        //判断状态是否为审批中
        if(!BusCarPackageAudit.STATUS_IN_ROGRESS.equals(carPackageAudit.getStatus())){
            throw new RuntimeException("非法操作");
        }
        //通过流程实例获取到当前任务节点
        Task currentTask = taskService.
                createTaskQuery().
                processInstanceId(carPackageAudit.getInstanceId()).
                singleResult();
        //添加批注
        String message = "";
        if(vo.getAuditStatus().equals("true")){
            message ="审批人" +  SecurityUtils.getUsername() + "同意-审批意见[" + vo.getInfo() + "]";
        }else{
            message ="审批人" +  SecurityUtils.getUsername() + "同意-审批拒绝[" + vo.getInfo() + "]";
        }

        taskService.addComment(currentTask.getId(),carPackageAudit.getInstanceId(),message);

        // 设置环境变量
        Map<String,Object> map = new HashMap<>();
        map.put("shopOwner",Boolean.valueOf(vo.getAuditStatus()));

        //调用activiti api 去完成任务
        taskService.complete(currentTask.getId(),map);
        //判断是同意还是拒绝
        if(vo.getAuditStatus().equals("true")){
            //如果是统一, 看是否有下一个节点, 如果没有下一个节点,修改 状态为拒绝状态和单项状态为同意状态
            Task nextTask = taskService.
                    createTaskQuery().
                    processInstanceId(carPackageAudit.getInstanceId()).
                    singleResult();
            //如果有不做任何事情
            if(nextTask == null){
                //如果是拒绝,修改 carPackageAudit 状态为拒绝状态和单项状态为拒绝状态
                busCarPackageAuditMapper.updateStatus(vo.getId(),BusCarPackageAudit.STATUS_PASS);

                serviceItemMapper.updateAuitStatus(carPackageAudit.getServiceItemId(), Integer.parseInt(BusServiceItem.AUDITSTATUS_APPROVED));

            }

        }else{
            //如果是拒绝,修改 carPackageAudit 状态为拒绝状态和单项状态为拒绝状态
            busCarPackageAuditMapper.updateStatus(vo.getId(),BusCarPackageAudit.STATUS_REJECT);

            serviceItemMapper.updateAuitStatus(carPackageAudit.getServiceItemId(), Integer.parseInt(BusServiceItem.AUDITSTATUS_REPLY));
        }

    }
```

### 3.7.6、审批历史

#### 3.7.6.1、界面效果

![image-20221207125217342](images/image-20221207125217342.png)

#### 3.7.6.2、处理前端

添加模态框

```html
<el-dialog title="审批历史" :visible.sync="historyDialog.open" width="1200px" append-to-body>
  <el-table ref="tables" v-loading="historyDialog.loading" :data="historyDialog.list" :default-sort="defaultSort">
    <el-table-column label="任务名称" align="center" prop="taskName"/>
    <el-table-column label="开始时间" align="center" prop="startTime" width="180"/>
    <el-table-column label="结束时间" align="center" prop="endTime" width="180" :show-overflow-tooltip="true"/>
    <el-table-column label="耗时" align="center" prop="durationInMillis" width="180"/>
    <el-table-column label="审批意见" align="center" prop="comment" width="180"/>
  </el-table>
  <div slot="footer" class="dialog-footer">
    <el-button @click="cancel">关 闭</el-button>
  </div>
</el-dialog>
```

添加 data

```js
// 审批历史弹窗
historyDialog: {
  open: false,
  loading: false,
  list: [],
},
```

添加方法 ：

```js
listHistory(instanceId){
  this.historyDialog.open = true
  this.historyDialog.loading = true
  // 请求审批历史接口的方法
  carPackageAuditHistory(instanceId).then((res) => {
    this.historyDialog.list = res.rows;
    this.historyDialog.loading = false;
  });
},
```

#### 3.7.6.3、处理后端

实现思路：

- 创建 VO 对象封装展示列表数据
- 查询 bpmnInfo 信息
- 根据当前用户id查询历史实例集合
- 遍历流程实例集合，把数据封装到 vo 集合中

代码：

```java
 @Override
    public List<HistoryVO> queryHistory(Long instanceId) {
        //参数校验
        if(instanceId == null){
            throw new RuntimeException("非法操作");
        }

        //查询 bpmnInfo 信息
        BusBpmnInfo busBpmnInfo = busBpmnInfoMapper.queryByType(BusCarPackageAudit.FLOW_AUDIT_TYPE);
        //根据流程实例 id 查询历史任务表
        List<HistoricTaskInstance> list = historyService.createHistoricTaskInstanceQuery().
                processInstanceId(instanceId + "").
//                taskAssignee(SecurityUtils.getUserId() + "").
                processDefinitionKey(busBpmnInfo.getProcessDefinitionKey()).
                finished().
                list();

        List<HistoryVO> vos = new ArrayList<>();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        for (HistoricTaskInstance task : list) {
            HistoryVO vo = new HistoryVO();
            vo.setTaskName(task.getName());
            vo.setStartTime(sdf.format(task.getStartTime()));
            vo.setEndTime(sdf.format(task.getEndTime()));
            vo.setDurationInMillis(task.getDurationInMillis()/1000+"s");
            List<Comment> comments = taskService.getTaskComments(task.getId());
            if(comments.size()>0){
                vo.setComment(comments.get(0).getFullMessage());
            }
            vos.add(vo);
        }
        return vos;

    }

```

## 3.8：我的已办

### 3.8.1、功能描述

我的已办，即查看当前登录用户参与过审核的流程历史任务

原型：

![image-20221207130153001](images/image-20221207130153001.png)

### 3.8.2、具体需求

1、我的已办列表

2、查看审核进度

### 3.8.3、已办列表

#### 3.8.3.1、界面效果

![image-20221207130434131](images/image-20221207130434131.png)

#### 3.8.3.2、处理前端

准备工作：添加菜单

![image-20221207130518542](images/image-20221207130518542.png)

在 business/carPackageAudit 中创建 doneQuery， 拷贝准备好的index.vue

Index.vue

```html
<template>
  <div class="app-container">
    <!--  表格内容  -->
    <el-table
      ref="tables"
      v-loading="loading"
      :data="list"
      :default-sort="defaultSort"
      @sort-change="handleSortChange"
    >
      <el-table-column label="套餐名称" align="center" prop="serviceItemName" />
      <el-table-column
        label="套餐价格"
        align="center"
        prop="serviceItemPrice"
      />
      <el-table-column
        label="套餐备注"
        align="center"
        prop="serviceItemInfo"
        width="130"
        :show-overflow-tooltip="true"
      />
      <el-table-column
        label="创建时间"
        align="center"
        prop="createTime"
        width="180"
      />
      <el-table-column label="状态" align="center" prop="status">
        <template slot-scope="scope">
          <dict-tag
            :options="dict.type.bus_car_audit_status"
            :value="scope.row.status"
          />
        </template>
      </el-table-column>
      <el-table-column
        label="操作"
        align="center"
        class-name="small-padding fixed-width"
      >
        <template slot-scope="scope">
          <el-button
            size="mini"
            type="text"
            icon="el-icon-info"
            @click="listHistory(scope.row.instanceId)"
            >审批历史
          </el-button>

          <el-button
            size="mini"
            type="text"
            icon="el-icon-info"
            @click="viewProcess(scope.row.id)"
          >进度查看</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!--  表格分页栏  -->
    <pagination
      v-show="total > 0"
      :total="total"
      :page.sync="queryParams.pageNum"
      :limit.sync="queryParams.pageSize"
      @pagination="getList"
    />
    <!--  审批历史对话框  -->
    <el-dialog
      title="审批历史"
      :visible.sync="historyDialog.open"
      width="1200px"
      append-to-body
    >
      <el-table
        ref="tables"
        v-loading="historyDialog.loading"
        :data="historyDialog.list"
        :default-sort="defaultSort"
      >
        <el-table-column label="任务名称" align="center" prop="taskName" />
        <el-table-column label="开始时间" align="center" prop="startTime"   width="180" />
        <el-table-column
          label="结束时间"
          align="center"
          prop="endTime"
          width="180"
          :show-overflow-tooltip="true"
        />
        <el-table-column
          label="耗时"
          align="center"
          prop="durationInMillis"
          width="180"
        />
        <el-table-column
          label="审批意见"
          align="center"
          prop="comment"
          width="180"
        />
      </el-table>
      <div slot="footer" class="dialog-footer">
        <el-button @click="closeHistoryDialog">关 闭</el-button>
      </div>
    </el-dialog>
    <!--  流程进度图对话框  -->
    <el-dialog
      title="流程进度图"
      :visible.sync="processDialog.open"
      width="1200px"
      append-to-body
    >
      <div v-html="processDialog.img"></div>
      <div slot="footer" class="dialog-footer">
        <el-button @click="closeProcessDialog">关 闭</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import {
  listDone,
  carPackageAuditHistory,
  carPackageAuditProcess,
} from "@/api/business/audit.js";

export default {
  name: "Audit",
  dicts: ["bus_car_audit_status"],
  data() {
    return {
      // 遮罩层
      loading: true,
      // 选中数组
      ids: [],
      // 非多个禁用
      multiple: true,
      // 显示搜索条件
      showSearch: true,
      // 总条数
      total: 0,
      // 表格数据
      list: [],
      // 日期范围
      dateRange: [],
      // 默认排序
      defaultSort: { prop: "loginTime", order: "descending" },
      // 查询参数
      queryParams: {
        pageNum: 1,
        pageSize: 10,
        status: undefined,
      },
      // 审批历史弹窗
      historyDialog: {
        open: false,
        loading: false,
        list: [],
      },
      // 流程进度图弹窗
      processDialog: {
        open: false,
        img: "",
      }
    };
  },
  created() {
    this.getList();
  },
  methods: {
    /** 我的已办列表 */
    getList() {
      this.loading = true;
      listDone(this.queryParams).then(
        (response) => {
          this.list = response.rows;
          this.total = response.total;
          this.loading = false;
        }
      );
    },
    /** 搜索按钮操作 */
    handleQuery() {
      this.queryParams.pageNum = 1;
      this.getList();
    },
    /** 重置按钮操作 */
    resetQuery() {
      this.dateRange = [];
      this.resetForm("queryForm");
      this.$refs.tables.sort(this.defaultSort.prop, this.defaultSort.order);
      this.handleQuery();
    },
    /** 排序触发事件 */
    handleSortChange(column, prop, order) {
      this.queryParams.orderByColumn = column.prop;
      this.queryParams.isAsc = column.order;
      this.getList();
    },
      listHistory(instanceId) {
        this.historyDialog.open = true;
        this.historyDialog.loading = true;
        // 请求审批历史接口的方法
        carPackageAuditHistory(instanceId).then((res) => {
          this.historyDialog.list = res.rows;
          this.historyDialog.loading = false;
        });
      },
      viewProcess(id) {
        this.processDialog.open = true;
        carPackageAuditProcess(id).then((res) => {
          this.processDialog.img = res;
        });
      },
      closeHistoryDialog() {
        this.historyDialog.open = false;
      },
      closeProcessDialog() {
        this.processDialog.open = false;
      },
  },
};
</script>
    
```

#### 3.8.3.3、处理后端

实现思路：

- 查询 bpmnInfo 信息
- 查询待办任务
- 根据用户 id 和 key 查询历史任务集合
- 如果不为空
- 遍历获取到 businessKey 集合
- 根据集合查询业务表数据

代码：

```java
@Override
public List<BusCarPackageAudit> doneQuery(BusCarPackageAudit busServiceItem) {
    // 先查询 bpmninfo 信息
    BusBpmnInfo busBpmnInfo = busBpmnInfoMapper.queryByType(BusCarPackageAudit.FLOW_AUDIT_TYPE);
    if(busBpmnInfo == null){
        throw new RuntimeException("非法操作");
    }
    //查询待办任务
    List<HistoricTaskInstance> list = historyService.createHistoricTaskInstanceQuery().
            taskAssignee(SecurityUtils.getUserId().toString()).
            processDefinitionKey(busBpmnInfo.getProcessDefinitionKey()).list();

    if(list == null || list.size() == 0){
        return null;
    }
    //根据任务查询流程实例 id集合
    List<String> keys = new ArrayList<>();
    for (HistoricTaskInstance task : list) {
        HistoricProcessInstance historicProcessInstance = historyService.
                createHistoricProcessInstanceQuery().
                processInstanceId(task.getProcessInstanceId()).
                singleResult();
        String businessKey = historicProcessInstance.getBusinessKey();
        keys.add(businessKey);
    }
    //根据流程实例 id 查询,businesskey 结合
    PageUtils.startPage();
    //根据 userId 去查询
    List<BusCarPackageAudit> carPackageAudits = busCarPackageAuditMapper.queryBusinessKeys(keys);
    return carPackageAudits;
}
```